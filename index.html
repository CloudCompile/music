<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="CloudTunes Player - A full-featured web music player">
    <meta name="theme-color" content="#1DB954">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 180 180'><rect width='180' height='180' rx='40' fill='%231DB954'/><text x='50%25' y='55%25' font-family='Arial' font-size='100' fill='white' text-anchor='middle' dominant-baseline='middle'>♪</text></svg>">
    <title>CloudTunes Player</title>
    <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jsmediatags/3.9.5/jsmediatags.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        
        :root {
            --bg-primary: #121212;
            --bg-secondary: #181818;
            --bg-tertiary: #282828;
            --text-primary: #ffffff;
            --text-secondary: #b3b3b3;
            --accent-primary: #1DB954;
            --accent-hover: #1ed760;
            --glass-bg: rgba(255, 255, 255, 0.05);
            --glass-border: rgba(255, 255, 255, 0.1);
            --glass-blur: 20px;
        }

        .theme-light {
            --bg-primary: #f5f5f5;
            --bg-secondary: #e5e5e5;
            --bg-tertiary: #d5d5d5;
            --text-primary: #121212;
            --text-secondary: #535353;
            --glass-bg: rgba(255, 255, 255, 0.7);
            --glass-border: rgba(0, 0, 0, 0.1);
        }

        .theme-purple {
            --bg-primary: #1a0a2e;
            --bg-secondary: #2d1b4e;
            --bg-tertiary: #3d2b5e;
            --accent-primary: #9d4edd;
            --accent-hover: #c77dff;
            --glass-bg: rgba(157, 78, 221, 0.1);
            --glass-border: rgba(157, 78, 221, 0.2);
        }

        .theme-ocean {
            --bg-primary: #0a192f;
            --bg-secondary: #112240;
            --bg-tertiary: #1d3456;
            --accent-primary: #64ffda;
            --accent-hover: #8bffe8;
            --glass-bg: rgba(100, 255, 218, 0.05);
            --glass-border: rgba(100, 255, 218, 0.1);
        }

        * {
            font-family: 'Inter', sans-serif;
        }
        
        body {
            background: var(--bg-primary);
            color: var(--text-primary);
        }
        
        ::-webkit-scrollbar {
            width: 8px;
        }
        
        ::-webkit-scrollbar-track {
            background: var(--bg-primary);
        }
        
        ::-webkit-scrollbar-thumb {
            background: #535353;
            border-radius: 4px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: #727272;
        }

        /* Glassmorphic styles */
        .glass {
            background: var(--glass-bg);
            backdrop-filter: blur(var(--glass-blur));
            -webkit-backdrop-filter: blur(var(--glass-blur));
            border: 1px solid var(--glass-border);
        }

        .glass-card {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 16px;
        }

        .glass-sidebar {
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-right: 1px solid rgba(255, 255, 255, 0.1);
        }

        .glass-modal {
            background: rgba(30, 30, 30, 0.95);
            backdrop-filter: blur(30px);
            -webkit-backdrop-filter: blur(30px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .glass-controls {
            background: linear-gradient(to top, rgba(0, 0, 0, 0.9), rgba(0, 0, 0, 0.7), transparent);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
        }
        
        .progress-bar::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #fff;
            cursor: pointer;
            opacity: 0;
            transition: opacity 0.2s;
        }
        
        .progress-bar:hover::-webkit-slider-thumb {
            opacity: 1;
        }
        
        .progress-bar::-webkit-slider-runnable-track {
            height: 4px;
            border-radius: 2px;
        }
        
        .volume-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #fff;
            cursor: pointer;
            opacity: 0;
            transition: opacity 0.2s;
        }
        
        .volume-slider:hover::-webkit-slider-thumb,
        .volume-container:hover .volume-slider::-webkit-slider-thumb {
            opacity: 1;
        }
        
        .album-art {
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        
        .album-art:hover {
            transform: scale(1.02);
            box-shadow: 0 8px 24px rgba(0,0,0,0.5);
        }
        
        .queue-item {
            transition: all 0.2s ease;
        }
        
        .queue-item:hover {
            background: rgba(255,255,255,0.1);
        }
        
        .queue-item.active {
            background: rgba(29, 185, 84, 0.3);
        }
        
        .control-btn {
            transition: all 0.15s ease;
        }
        
        .control-btn:hover {
            transform: scale(1.1);
        }
        
        .control-btn:active {
            transform: scale(0.95);
        }
        
        .play-btn {
            transition: all 0.15s ease;
        }
        
        .play-btn:hover {
            transform: scale(1.08);
            background: var(--accent-hover) !important;
        }
        
        .fade-in {
            animation: fadeIn 0.3s ease-out;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .slide-in-left {
            animation: slideInLeft 0.3s ease-out;
        }

        @keyframes slideInLeft {
            from { opacity: 0; transform: translateX(-100%); }
            to { opacity: 1; transform: translateX(0); }
        }

        .slide-out-left {
            animation: slideOutLeft 0.3s ease-out forwards;
        }

        @keyframes slideOutLeft {
            from { opacity: 1; transform: translateX(0); }
            to { opacity: 0; transform: translateX(-100%); }
        }

        .modal-fade-in {
            animation: modalFadeIn 0.2s ease-out;
        }

        @keyframes modalFadeIn {
            from { opacity: 0; transform: scale(0.95); }
            to { opacity: 1; transform: scale(1); }
        }

        .pulse-animation {
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
        
        .rotating {
            animation: rotate 20s linear infinite;
        }
        
        @keyframes rotate {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        
        .rotating.paused {
            animation-play-state: paused;
        }

        .sidebar-collapsed {
            width: 0 !important;
            padding: 0 !important;
            overflow: hidden;
        }

        .sidebar-toggle {
            transition: all 0.3s ease;
        }

        .nav-item {
            transition: all 0.2s ease;
        }

        .nav-item:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .nav-item.active {
            background: rgba(29, 185, 84, 0.2);
            color: var(--accent-primary);
        }

        /* Mobile responsive */
        @media (max-width: 768px) {
            .sidebar {
                position: fixed;
                z-index: 50;
                height: 100vh;
            }

            .sidebar.sidebar-collapsed {
                transform: translateX(-100%);
            }
        }

        /* Custom scrollbar for light theme */
        .theme-light ::-webkit-scrollbar-track {
            background: var(--bg-secondary);
        }

        .theme-light ::-webkit-scrollbar-thumb {
            background: #999;
        }

        /* Tab styles */
        .tab-btn {
            transition: all 0.2s ease;
        }

        .tab-btn.active {
            color: var(--accent-primary);
            border-bottom: 2px solid var(--accent-primary);
        }

        /* Playlist item */
        .playlist-item {
            transition: all 0.2s ease;
        }

        .playlist-item:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        /* Toast notification */
        .toast {
            animation: toastSlideIn 0.3s ease-out;
        }

        @keyframes toastSlideIn {
            from { transform: translateY(100%); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        /* Loading spinner */
        .spinner {
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        /* Accent color for buttons */
        .btn-accent {
            background: var(--accent-primary);
        }

        .btn-accent:hover {
            background: var(--accent-hover);
        }

        /* Ensure hidden class works with flex */
        .hidden {
            display: none !important;
        }

        /* Picture-in-Picture Player */
        .pip-player {
            position: fixed;
            bottom: 120px;
            right: 20px;
            width: 320px;
            z-index: 45;
            background: rgba(20, 20, 20, 0.95);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 16px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
            overflow: hidden;
            transition: all 0.3s ease;
            cursor: grab;
        }

        .pip-player:active {
            cursor: grabbing;
        }

        .pip-player.minimized {
            width: 200px;
        }

        .pip-player.minimized .pip-album-art {
            width: 60px;
            height: 60px;
        }

        .pip-player.minimized .pip-info {
            flex: 1;
        }

        .pip-player.minimized .pip-controls {
            display: none;
        }

        .pip-header {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            background: rgba(0, 0, 0, 0.3);
        }

        .pip-album-art {
            width: 80px;
            height: 80px;
            border-radius: 8px;
            overflow: hidden;
            flex-shrink: 0;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.4);
        }

        .pip-album-art img,
        .pip-album-art video {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .pip-info {
            flex: 1;
            min-width: 0;
        }

        .pip-title {
            font-size: 14px;
            font-weight: 600;
            color: white;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            margin-bottom: 4px;
        }

        .pip-artist {
            font-size: 12px;
            color: #b3b3b3;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            margin-bottom: 2px;
        }

        .pip-album {
            font-size: 11px;
            color: #888;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            font-style: italic;
        }

        .pip-close {
            position: absolute;
            top: 8px;
            right: 8px;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.1);
            border: none;
            color: #b3b3b3;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
            font-size: 12px;
        }

        .pip-close:hover {
            background: rgba(255, 255, 255, 0.2);
            color: white;
        }

        .pip-controls {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 16px;
            padding: 12px;
            background: rgba(0, 0, 0, 0.2);
        }

        .pip-control-btn {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border: none;
            background: transparent;
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.15s ease;
        }

        .pip-control-btn:hover {
            transform: scale(1.1);
            color: var(--accent-primary);
        }

        .pip-control-btn.play-pause {
            width: 44px;
            height: 44px;
            background: var(--accent-primary);
        }

        .pip-control-btn.play-pause:hover {
            background: var(--accent-hover);
            color: white;
            transform: scale(1.08);
        }

        .pip-progress {
            height: 3px;
            background: rgba(255, 255, 255, 0.1);
            position: relative;
        }

        .pip-progress-fill {
            height: 100%;
            background: var(--accent-primary);
            transition: width 0.1s linear;
        }

        /* PiP toggle button active state */
        .pip-toggle.active {
            color: var(--accent-primary) !important;
        }

        /* Slide in animation for PiP */
        .pip-slide-in {
            animation: pipSlideIn 0.3s ease-out;
        }

        @keyframes pipSlideIn {
            from {
                opacity: 0;
                transform: translateX(100%);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        .pip-slide-out {
            animation: pipSlideOut 0.3s ease-out forwards;
        }

        @keyframes pipSlideOut {
            from {
                opacity: 1;
                transform: translateX(0);
            }
            to {
                opacity: 0;
                transform: translateX(100%);
            }
        }
    </style>
</head>
<body class="bg-gradient-to-b from-zinc-900 to-black min-h-screen text-white">
    <!-- Toast Container -->
    <div id="toastContainer" class="fixed bottom-24 left-1/2 transform -translate-x-1/2 z-50 flex flex-col gap-2"></div>

    <!-- Picture-in-Picture Player -->
    <div id="pipPlayer" class="pip-player hidden pip-slide-in">
        <button id="pipClose" class="pip-close" title="Close PiP">
            <i class="fas fa-times"></i>
        </button>
        <div class="pip-header">
            <div class="pip-album-art">
                <img id="pipAlbumArt" src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Crect fill='%23333' width='100' height='100'/%3E%3Ctext x='50' y='55' font-family='Arial' font-size='40' fill='%23666' text-anchor='middle'%3E♪%3C/text%3E%3C/svg%3E" alt="Album Art">
                <video id="pipVideo" class="hidden" muted></video>
            </div>
            <div class="pip-info">
                <div id="pipTitle" class="pip-title">No Track</div>
                <div id="pipArtist" class="pip-artist">Select a song</div>
                <div id="pipAlbum" class="pip-album"></div>
            </div>
        </div>
        <div class="pip-progress">
            <div id="pipProgressFill" class="pip-progress-fill" style="width: 0%"></div>
        </div>
        <div class="pip-controls">
            <button id="pipPrevBtn" class="pip-control-btn" title="Previous">
                <i class="fas fa-step-backward"></i>
            </button>
            <button id="pipPlayBtn" class="pip-control-btn play-pause" title="Play">
                <i class="fas fa-play"></i>
            </button>
            <button id="pipNextBtn" class="pip-control-btn" title="Next">
                <i class="fas fa-step-forward"></i>
            </button>
        </div>
    </div>

    <!-- Auth Modal -->
    <div id="authModal" class="fixed inset-0 bg-black/80 z-50 hidden flex items-center justify-center p-4">
        <div class="glass-modal rounded-2xl p-8 max-w-md w-full modal-fade-in">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold">Welcome to CloudTunes</h2>
                <button id="closeAuthModal" class="text-zinc-400 hover:text-white">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            
            <!-- Auth Tabs -->
            <div class="flex border-b border-zinc-700 mb-6">
                <button class="tab-btn active flex-1 py-3 text-center" data-tab="login">Sign In</button>
                <button class="tab-btn flex-1 py-3 text-center text-zinc-400" data-tab="register">Sign Up</button>
            </div>

            <!-- Login Form -->
            <div id="loginTab" class="auth-tab">
                <form id="loginForm" class="space-y-4">
                    <div>
                        <label class="block text-sm text-zinc-400 mb-2">Email</label>
                        <input type="email" id="loginEmail" class="w-full bg-zinc-800 border border-zinc-700 rounded-lg px-4 py-3 text-white focus:outline-none focus:border-green-500" placeholder="your@email.com" required>
                    </div>
                    <div>
                        <label class="block text-sm text-zinc-400 mb-2">Password</label>
                        <input type="password" id="loginPassword" class="w-full bg-zinc-800 border border-zinc-700 rounded-lg px-4 py-3 text-white focus:outline-none focus:border-green-500" placeholder="••••••••" required>
                    </div>
                    <button type="submit" class="w-full btn-accent text-white font-semibold py-3 rounded-lg transition">
                        Sign In
                    </button>
                </form>
                
                <div class="relative my-6">
                    <div class="absolute inset-0 flex items-center">
                        <div class="w-full border-t border-zinc-700"></div>
                    </div>
                    <div class="relative flex justify-center text-sm">
                        <span class="px-4 bg-zinc-900 text-zinc-400">or continue with</span>
                    </div>
                </div>

                <button id="googleLoginBtn" class="w-full bg-white text-gray-800 font-semibold py-3 rounded-lg transition hover:bg-gray-100 flex items-center justify-center gap-3">
                    <i class="fab fa-google text-lg"></i>
                    Sign in with Google
                </button>
            </div>

            <!-- Register Form -->
            <div id="registerTab" class="auth-tab hidden">
                <form id="registerForm" class="space-y-4">
                    <div>
                        <label class="block text-sm text-zinc-400 mb-2">Display Name</label>
                        <input type="text" id="registerName" class="w-full bg-zinc-800 border border-zinc-700 rounded-lg px-4 py-3 text-white focus:outline-none focus:border-green-500" placeholder="Your Name" required>
                    </div>
                    <div>
                        <label class="block text-sm text-zinc-400 mb-2">Email</label>
                        <input type="email" id="registerEmail" class="w-full bg-zinc-800 border border-zinc-700 rounded-lg px-4 py-3 text-white focus:outline-none focus:border-green-500" placeholder="your@email.com" required>
                    </div>
                    <div>
                        <label class="block text-sm text-zinc-400 mb-2">Password</label>
                        <input type="password" id="registerPassword" class="w-full bg-zinc-800 border border-zinc-700 rounded-lg px-4 py-3 text-white focus:outline-none focus:border-green-500" placeholder="••••••••" required minlength="6">
                    </div>
                    <button type="submit" class="w-full btn-accent text-white font-semibold py-3 rounded-lg transition">
                        Create Account
                    </button>
                </form>
                
                <div class="relative my-6">
                    <div class="absolute inset-0 flex items-center">
                        <div class="w-full border-t border-zinc-700"></div>
                    </div>
                    <div class="relative flex justify-center text-sm">
                        <span class="px-4 bg-zinc-900 text-zinc-400">or continue with</span>
                    </div>
                </div>

                <button id="googleRegisterBtn" class="w-full bg-white text-gray-800 font-semibold py-3 rounded-lg transition hover:bg-gray-100 flex items-center justify-center gap-3">
                    <i class="fab fa-google text-lg"></i>
                    Sign up with Google
                </button>
            </div>

            <p id="authError" class="text-red-500 text-sm mt-4 hidden"></p>
        </div>
    </div>

    <!-- Settings Modal -->
    <div id="settingsModal" class="fixed inset-0 bg-black/80 z-50 hidden flex items-center justify-center p-4">
        <div class="glass-modal rounded-2xl p-6 max-w-lg w-full max-h-[90vh] overflow-y-auto modal-fade-in">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold">Settings</h2>
                <button id="closeSettings" class="text-zinc-400 hover:text-white">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>

            <!-- Theme Selection -->
            <div class="mb-6">
                <h3 class="text-lg font-semibold mb-3">Theme</h3>
                <div class="grid grid-cols-4 gap-3">
                    <button class="theme-option p-3 rounded-lg border-2 border-transparent hover:border-green-500 transition" data-theme="default">
                        <div class="w-full h-8 rounded bg-gradient-to-r from-zinc-900 to-black mb-2"></div>
                        <span class="text-xs">Dark</span>
                    </button>
                    <button class="theme-option p-3 rounded-lg border-2 border-transparent hover:border-green-500 transition" data-theme="light">
                        <div class="w-full h-8 rounded bg-gradient-to-r from-gray-100 to-gray-200 mb-2"></div>
                        <span class="text-xs">Light</span>
                    </button>
                    <button class="theme-option p-3 rounded-lg border-2 border-transparent hover:border-green-500 transition" data-theme="purple">
                        <div class="w-full h-8 rounded bg-gradient-to-r from-purple-900 to-purple-600 mb-2"></div>
                        <span class="text-xs">Purple</span>
                    </button>
                    <button class="theme-option p-3 rounded-lg border-2 border-transparent hover:border-green-500 transition" data-theme="ocean">
                        <div class="w-full h-8 rounded bg-gradient-to-r from-blue-900 to-teal-500 mb-2"></div>
                        <span class="text-xs">Ocean</span>
                    </button>
                </div>
            </div>

            <!-- Advanced Mode -->
            <div class="mb-6">
                <h3 class="text-lg font-semibold mb-3">Advanced Mode</h3>
                <label class="flex items-center justify-between p-4 bg-zinc-800 rounded-lg cursor-pointer">
                    <div>
                        <span class="font-medium">Enable Advanced Mode</span>
                        <p class="text-sm text-zinc-400">Edit MP3/MP4 metadata and access advanced options</p>
                    </div>
                    <input type="checkbox" id="advancedMode" class="w-5 h-5 accent-green-500">
                </label>
            </div>

            <!-- PWA Install -->
            <div class="mb-6" id="pwaSection">
                <h3 class="text-lg font-semibold mb-3">Install App</h3>
                <button id="pwaInstallBtn" class="w-full btn-accent text-white font-semibold py-3 rounded-lg transition flex items-center justify-center gap-2">
                    <i class="fas fa-download"></i>
                    Install CloudTunes
                </button>
                <p class="text-sm text-zinc-400 mt-2">Install as a Progressive Web App for offline access</p>
            </div>

            <!-- Version Info -->
            <div class="mb-6">
                <h3 class="text-lg font-semibold mb-3">Version Info</h3>
                <div class="p-4 bg-zinc-800 rounded-lg">
                    <div class="flex justify-between items-center">
                        <span>Current Version</span>
                        <span class="font-mono text-green-500" id="versionNumber">v1.0.0</span>
                    </div>
                    <button id="checkUpdatesBtn" class="mt-3 text-sm text-green-500 hover:text-green-400">
                        <i class="fas fa-sync-alt mr-1"></i> Check for updates
                    </button>
                </div>
            </div>

            <!-- Changelog -->
            <div>
                <h3 class="text-lg font-semibold mb-3">Changelog</h3>
                <button id="viewChangelogBtn" class="w-full bg-zinc-800 hover:bg-zinc-700 text-white font-semibold py-3 rounded-lg transition flex items-center justify-center gap-2">
                    <i class="fas fa-list"></i>
                    View Changelog
                </button>
            </div>
        </div>
    </div>

    <!-- Changelog Modal -->
    <div id="changelogModal" class="fixed inset-0 bg-black/80 z-50 hidden flex items-center justify-center p-4">
        <div class="glass-modal rounded-2xl p-6 max-w-lg w-full max-h-[90vh] overflow-y-auto modal-fade-in">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold">Changelog</h2>
                <button id="closeChangelog" class="text-zinc-400 hover:text-white">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>

            <div class="space-y-6">
                <div class="border-l-2 border-green-500 pl-4">
                    <div class="flex items-center gap-2 mb-2">
                        <span class="font-mono text-green-500">v1.0.0</span>
                        <span class="text-zinc-400 text-sm">- Initial Release</span>
                    </div>
                    <ul class="text-sm text-zinc-300 space-y-1">
                        <li>• Full-featured music player with queue management</li>
                        <li>• MP3 and MP4 file support with metadata parsing</li>
                        <li>• Firebase Authentication (Email/Password + Google)</li>
                        <li>• Playlist creation and management</li>
                        <li>• Multiple themes (Dark, Light, Purple, Ocean)</li>
                        <li>• PWA support for offline access</li>
                        <li>• Glassmorphic UI design</li>
                        <li>• Keyboard shortcuts for playback control</li>
                        <li>• Shuffle and repeat modes</li>
                        <li>• Volume control with visual feedback</li>
                        <li>• Favorites/liked songs system</li>
                        <li>• Advanced mode for metadata editing</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <!-- Playlist Modal -->
    <div id="playlistModal" class="fixed inset-0 bg-black/80 z-50 hidden flex items-center justify-center p-4">
        <div class="glass-modal rounded-2xl p-6 max-w-lg w-full max-h-[90vh] overflow-y-auto modal-fade-in">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold" id="playlistModalTitle">Create Playlist</h2>
                <button id="closePlaylist" class="text-zinc-400 hover:text-white">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>

            <form id="playlistForm" class="space-y-4">
                <div>
                    <label class="block text-sm text-zinc-400 mb-2">Playlist Name</label>
                    <input type="text" id="playlistName" class="w-full bg-zinc-800 border border-zinc-700 rounded-lg px-4 py-3 text-white focus:outline-none focus:border-green-500" placeholder="My Playlist" required>
                </div>
                <div>
                    <label class="block text-sm text-zinc-400 mb-2">Description (optional)</label>
                    <textarea id="playlistDescription" class="w-full bg-zinc-800 border border-zinc-700 rounded-lg px-4 py-3 text-white focus:outline-none focus:border-green-500 resize-none" rows="2" placeholder="Describe your playlist"></textarea>
                </div>
                <input type="hidden" id="editPlaylistId">
                <button type="submit" class="w-full btn-accent text-white font-semibold py-3 rounded-lg transition">
                    Save Playlist
                </button>
            </form>
        </div>
    </div>

    <!-- Metadata Editor Modal (Advanced Mode) -->
    <div id="metadataModal" class="fixed inset-0 bg-black/80 z-50 hidden flex items-center justify-center p-4">
        <div class="glass-modal rounded-2xl p-6 max-w-lg w-full max-h-[90vh] overflow-y-auto modal-fade-in">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold">Edit Metadata</h2>
                <button id="closeMetadata" class="text-zinc-400 hover:text-white">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>

            <form id="metadataForm" class="space-y-4">
                <div>
                    <label class="block text-sm text-zinc-400 mb-2">Title</label>
                    <input type="text" id="metaTitle" class="w-full bg-zinc-800 border border-zinc-700 rounded-lg px-4 py-3 text-white focus:outline-none focus:border-green-500">
                </div>
                <div>
                    <label class="block text-sm text-zinc-400 mb-2">Artist</label>
                    <input type="text" id="metaArtist" class="w-full bg-zinc-800 border border-zinc-700 rounded-lg px-4 py-3 text-white focus:outline-none focus:border-green-500">
                </div>
                <div>
                    <label class="block text-sm text-zinc-400 mb-2">Album</label>
                    <input type="text" id="metaAlbum" class="w-full bg-zinc-800 border border-zinc-700 rounded-lg px-4 py-3 text-white focus:outline-none focus:border-green-500">
                </div>
                <div>
                    <label class="block text-sm text-zinc-400 mb-2">Genre</label>
                    <input type="text" id="metaGenre" class="w-full bg-zinc-800 border border-zinc-700 rounded-lg px-4 py-3 text-white focus:outline-none focus:border-green-500">
                </div>
                <div>
                    <label class="block text-sm text-zinc-400 mb-2">Year</label>
                    <input type="text" id="metaYear" class="w-full bg-zinc-800 border border-zinc-700 rounded-lg px-4 py-3 text-white focus:outline-none focus:border-green-500" placeholder="e.g., 2024">
                </div>
                <div>
                    <label class="block text-sm text-zinc-400 mb-2">Album Art</label>
                    <div class="flex gap-2">
                        <input type="file" id="metaAlbumArt" accept="image/*" class="hidden">
                        <button type="button" id="selectAlbumArtBtn" class="flex-1 bg-zinc-800 hover:bg-zinc-700 border border-zinc-700 rounded-lg px-4 py-3 text-white text-left transition">
                            <i class="fas fa-image mr-2"></i>
                            <span id="albumArtFileName">Choose image...</span>
                        </button>
                        <button type="button" id="clearAlbumArtBtn" class="bg-zinc-800 hover:bg-zinc-700 border border-zinc-700 rounded-lg px-4 py-3 text-zinc-400 hover:text-white transition">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                </div>
                <input type="hidden" id="editSongId">
                <div class="flex gap-3">
                    <button type="submit" class="flex-1 btn-accent text-white font-semibold py-3 rounded-lg transition">
                        <i class="fas fa-save mr-2"></i>Save Changes
                    </button>
                    <button type="button" id="downloadWithMetadataBtn" class="flex-1 bg-blue-600 hover:bg-blue-500 text-white font-semibold py-3 rounded-lg transition">
                        <i class="fas fa-download mr-2"></i>Download
                    </button>
                </div>
                <p class="text-xs text-zinc-500 text-center">Save updates metadata locally. Download creates a new file with embedded metadata.</p>
            </form>
        </div>
    </div>

    <div class="flex h-screen overflow-hidden">
        <!-- Sidebar / Queue -->
        <aside id="sidebar" class="sidebar w-80 glass-sidebar p-4 flex flex-col transition-all duration-300 overflow-hidden">
            <!-- Toggle Button (Mobile) -->
            <button id="sidebarToggle" class="md:hidden absolute top-4 -right-12 bg-zinc-800 p-2 rounded-r-lg z-10">
                <i class="fas fa-bars"></i>
            </button>

            <div class="flex items-center gap-2 mb-6">
                <i class="fas fa-cloud text-3xl text-green-500"></i>
                <span class="text-xl font-bold">CloudTunes</span>
                <button id="sidebarCollapseBtn" class="ml-auto text-zinc-400 hover:text-white hidden md:block">
                    <i class="fas fa-chevron-left"></i>
                </button>
            </div>

            <!-- User Section -->
            <div id="userSection" class="mb-4 p-3 glass-card rounded-lg">
                <div id="loggedOutView" class="flex items-center justify-between">
                    <span class="text-sm text-zinc-400">Sign in to save your data</span>
                    <button id="showAuthBtn" class="text-green-500 hover:text-green-400 text-sm font-semibold">
                        Sign In
                    </button>
                </div>
                <div id="loggedInView" class="hidden">
                    <div class="flex items-center gap-3">
                        <div id="userAvatar" class="w-10 h-10 rounded-full bg-green-500 flex items-center justify-center text-white font-bold">
                            U
                        </div>
                        <div class="flex-1 min-w-0">
                            <p id="userName" class="font-medium truncate">User</p>
                            <p id="userEmail" class="text-xs text-zinc-400 truncate">user@email.com</p>
                        </div>
                        <button id="logoutBtn" class="text-zinc-400 hover:text-white" title="Sign Out">
                            <i class="fas fa-sign-out-alt"></i>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Navigation -->
            <nav class="mb-4 space-y-1">
                <button class="nav-item w-full text-left p-3 rounded-lg flex items-center gap-3 active" data-view="queue">
                    <i class="fas fa-list w-5"></i>
                    <span>Queue</span>
                </button>
                <button class="nav-item w-full text-left p-3 rounded-lg flex items-center gap-3" data-view="playlists">
                    <i class="fas fa-folder w-5"></i>
                    <span>Playlists</span>
                </button>
                <button class="nav-item w-full text-left p-3 rounded-lg flex items-center gap-3" data-view="favorites">
                    <i class="fas fa-heart w-5"></i>
                    <span>Favorites</span>
                </button>
                <button id="settingsBtn" class="nav-item w-full text-left p-3 rounded-lg flex items-center gap-3">
                    <i class="fas fa-cog w-5"></i>
                    <span>Settings</span>
                </button>
            </nav>
            
            <!-- Upload Buttons -->
            <div class="mb-4 space-y-3">
                <input type="file" id="fileInput" accept="audio/*,video/mp4" multiple class="hidden">
                <button id="uploadBtn" class="w-full btn-accent text-white font-semibold py-3 px-4 rounded-lg transition flex items-center justify-center gap-2">
                    <i class="fas fa-upload"></i>
                    <span>Upload Music</span>
                </button>
                <button id="cloudBtn" class="w-full bg-zinc-800 hover:bg-zinc-700 text-white font-semibold py-3 px-4 rounded-lg transition flex items-center justify-center gap-2">
                    <i class="fab fa-github"></i>
                    <span>Load Cloud Library</span>
                </button>
            </div>

            <!-- Queue View -->
            <div id="queueView" class="view-panel flex-1 overflow-y-auto">
                <h2 class="text-sm font-semibold text-zinc-400 uppercase tracking-wider mb-4">Queue</h2>
                <div id="queue" class="space-y-1">
                    <!-- Queue items will be inserted here -->
                </div>
            </div>

            <!-- Playlists View -->
            <div id="playlistsView" class="view-panel flex-1 overflow-y-auto hidden">
                <div class="flex items-center justify-between mb-4">
                    <h2 class="text-sm font-semibold text-zinc-400 uppercase tracking-wider">Playlists</h2>
                    <button id="createPlaylistBtn" class="text-green-500 hover:text-green-400">
                        <i class="fas fa-plus"></i>
                    </button>
                </div>
                <div id="playlists" class="space-y-1">
                    <!-- Playlists will be inserted here -->
                </div>
            </div>

            <!-- Favorites View -->
            <div id="favoritesView" class="view-panel flex-1 overflow-y-auto hidden">
                <h2 class="text-sm font-semibold text-zinc-400 uppercase tracking-wider mb-4">Favorites</h2>
                <div id="favorites" class="space-y-1">
                    <!-- Favorites will be inserted here -->
                </div>
            </div>
            
            <div class="mt-4 pt-4 border-t border-zinc-800 space-y-2">
                <button id="clearQueue" class="text-sm text-zinc-400 hover:text-white transition block w-full text-left">
                    <i class="fas fa-trash-alt mr-2"></i>Clear Queue
                </button>
            </div>
        </aside>
        
        <!-- Sidebar Expand Button (when collapsed) -->
        <button id="sidebarExpandBtn" class="hidden fixed left-0 top-1/2 -translate-y-1/2 bg-zinc-800 hover:bg-zinc-700 p-2 rounded-r-lg z-40 transition-all">
            <i class="fas fa-chevron-right"></i>
        </button>

        <!-- Main Content -->
        <main class="flex-1 flex flex-col overflow-hidden">
            <!-- Now Playing Section -->
            <div class="flex-1 flex items-center justify-center p-8">
                <div class="text-center fade-in" id="nowPlaying">
                    <!-- Album Art -->
                    <div class="relative inline-block mb-8">
                        <div id="albumArtContainer" class="w-72 h-72 md:w-96 md:h-96 rounded-lg shadow-2xl overflow-hidden album-art glass-card">
                            <img id="albumArt" src="" alt="Album Art" class="w-full h-full object-cover">
                            <video id="videoPlayer" class="w-full h-full object-cover hidden"></video>
                        </div>
                        <div id="vinylOverlay" class="absolute inset-0 flex items-center justify-center bg-black/50 opacity-0 transition-opacity duration-300">
                            <i class="fas fa-music text-6xl text-white/50"></i>
                        </div>
                        <!-- Edit Metadata Button (Advanced Mode) -->
                        <button id="editMetadataBtn" class="absolute top-2 right-2 bg-black/50 hover:bg-black/70 text-white p-2 rounded-full hidden transition">
                            <i class="fas fa-edit"></i>
                        </button>
                    </div>
                    
                    <!-- Track Info -->
                    <div class="mb-4">
                        <h1 id="trackTitle" class="text-2xl md:text-3xl font-bold mb-2 transition-all duration-300">Select a Track</h1>
                        <p id="trackArtist" class="text-zinc-400 text-lg">Upload or browse to get started</p>
                        <p id="trackAlbum" class="text-zinc-500 text-sm mt-1 italic"></p>
                    </div>
                    
                    <!-- Like Button -->
                    <button id="likeBtn" class="text-zinc-400 hover:text-green-500 transition control-btn mb-4">
                        <i class="far fa-heart text-2xl"></i>
                    </button>
                </div>
            </div>
            
            <!-- Player Controls -->
            <div class="glass-controls p-6">
                <!-- Progress Bar -->
                <div class="max-w-3xl mx-auto mb-4">
                    <div class="flex items-center gap-3">
                        <span id="currentTime" class="text-xs text-zinc-400 w-10 text-right">0:00</span>
                        <div class="flex-1 relative group">
                            <div class="absolute inset-0 h-1 top-1/2 -translate-y-1/2 bg-zinc-600 rounded-full"></div>
                            <div id="progressFill" class="absolute h-1 top-1/2 -translate-y-1/2 bg-white group-hover:bg-green-500 rounded-full transition-colors" style="width: 0%"></div>
                            <input type="range" id="progressBar" min="0" max="100" value="0" 
                                class="progress-bar w-full h-1 bg-transparent appearance-none cursor-pointer relative z-10">
                        </div>
                        <span id="totalTime" class="text-xs text-zinc-400 w-10">0:00</span>
                    </div>
                </div>
                
                <!-- Control Buttons -->
                <div class="flex items-center justify-center gap-6">
                    <!-- Shuffle -->
                    <button id="shuffleBtn" class="text-zinc-400 hover:text-white transition control-btn" title="Shuffle">
                        <i class="fas fa-random text-lg"></i>
                    </button>
                    
                    <!-- Previous -->
                    <button id="prevBtn" class="text-white hover:text-green-500 transition control-btn" title="Previous">
                        <i class="fas fa-step-backward text-xl"></i>
                    </button>
                    
                    <!-- Play/Pause -->
                    <button id="playBtn" class="play-btn w-14 h-14 bg-white text-black rounded-full flex items-center justify-center" title="Play">
                        <i class="fas fa-play text-xl ml-1"></i>
                    </button>
                    
                    <!-- Next -->
                    <button id="nextBtn" class="text-white hover:text-green-500 transition control-btn" title="Next">
                        <i class="fas fa-step-forward text-xl"></i>
                    </button>
                    
                    <!-- Repeat -->
                    <button id="repeatBtn" class="text-zinc-400 hover:text-white transition control-btn" title="Repeat">
                        <i class="fas fa-redo text-lg"></i>
                    </button>
                    
                    <!-- PiP Toggle -->
                    <button id="pipToggleBtn" class="pip-toggle text-zinc-400 hover:text-white transition control-btn" title="Picture-in-Picture (floats across tabs/apps)">
                        <i class="fas fa-external-link-square-alt text-lg"></i>
                    </button>
                </div>
                
                <!-- Volume Control -->
                <div class="flex items-center justify-end gap-2 mt-4 volume-container">
                    <button id="volumeBtn" class="text-zinc-400 hover:text-white transition">
                        <i class="fas fa-volume-up"></i>
                    </button>
                    <div class="w-24 relative group">
                        <div class="absolute inset-0 h-1 top-1/2 -translate-y-1/2 bg-zinc-600 rounded-full"></div>
                        <div id="volumeFill" class="absolute h-1 top-1/2 -translate-y-1/2 bg-white group-hover:bg-green-500 rounded-full transition-colors" style="width: 70%"></div>
                        <input type="range" id="volumeSlider" min="0" max="100" value="70" 
                            class="volume-slider w-full h-1 bg-transparent appearance-none cursor-pointer relative z-10">
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Hidden Audio Element -->
    <audio id="audioPlayer"></audio>

    <!-- Firebase SDK -->
    <script type="module">
        // Import the functions you need from the SDKs you need
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-analytics.js";
        import { 
            getAuth, 
            signInWithEmailAndPassword, 
            createUserWithEmailAndPassword, 
            signInWithPopup, 
            GoogleAuthProvider,
            signOut,
            onAuthStateChanged,
            updateProfile
        } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-auth.js";
        import {
            getFirestore,
            doc,
            setDoc,
            getDoc
        } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js";

        // Your web app's Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyBN7ctL775CI1NyhYjqLoLgBljkTFyWtOA",
            authDomain: "cloudtunes-4cc0a.firebaseapp.com",
            projectId: "cloudtunes-4cc0a",
            storageBucket: "cloudtunes-4cc0a.firebasestorage.app",
            messagingSenderId: "901963678218",
            appId: "1:901963678218:web:5ad3e5b3ec121e762095f3",
            measurementId: "G-GXCR7RQSDF"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const analytics = getAnalytics(app);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const googleProvider = new GoogleAuthProvider();

        // Make Firebase functions available globally
        window.firebaseAuth = {
            auth,
            db,
            signInWithEmailAndPassword: (email, password) => signInWithEmailAndPassword(auth, email, password),
            createUserWithEmailAndPassword: (email, password) => createUserWithEmailAndPassword(auth, email, password),
            signInWithGoogle: () => signInWithPopup(auth, googleProvider),
            signOut: () => signOut(auth),
            updateProfile: (user, data) => updateProfile(user, data),
            onAuthStateChanged: (callback) => onAuthStateChanged(auth, callback),
            saveUserData: async (userId, data) => {
                try {
                    await setDoc(doc(db, "users", userId), data, { merge: true });
                } catch (error) {
                    console.error("Error saving user data:", error);
                }
            },
            getUserData: async (userId) => {
                try {
                    const docSnap = await getDoc(doc(db, "users", userId));
                    return docSnap.exists() ? docSnap.data() : null;
                } catch (error) {
                    console.error("Error getting user data:", error);
                    return null;
                }
            }
        };
    </script>

    <script>
        // App Version
        const APP_VERSION = 'v1.0.0';

        // No demo songs - start with empty queue
        const songs = [];

        // Player state
        let state = {
            queue: [...songs],
            currentIndex: 0,
            isPlaying: false,
            isShuffle: false,
            repeatMode: 0, // 0: off, 1: all, 2: one
            volume: 70,
            currentTime: 0,
            liked: new Set(),
            playlists: [],
            currentUser: null,
            advancedMode: false,
            theme: 'default',
            isVideo: false,
            isPipVisible: false,
            pipWindow: null // Reference to the browser PiP window
        };

        // Load state from localStorage
        function loadState() {
            try {
                const saved = localStorage.getItem('cloudtunes_state');
                if (saved) {
                    const parsed = JSON.parse(saved);
                    state.liked = new Set(parsed.liked || []);
                    state.playlists = parsed.playlists || [];
                    state.advancedMode = parsed.advancedMode || false;
                    state.theme = parsed.theme || 'default';
                    state.volume = parsed.volume || 70;
                }
            } catch (e) {
                console.error('Failed to load state:', e);
            }
        }

        // Save state to localStorage
        function saveState() {
            try {
                const toSave = {
                    liked: Array.from(state.liked),
                    playlists: state.playlists,
                    advancedMode: state.advancedMode,
                    theme: state.theme,
                    volume: state.volume
                };
                localStorage.setItem('cloudtunes_state', JSON.stringify(toSave));
            } catch (e) {
                console.error('Failed to save state:', e);
            }
        }

        // DOM Elements
        const elements = {
            queue: document.getElementById('queue'),
            albumArt: document.getElementById('albumArt'),
            albumArtContainer: document.getElementById('albumArtContainer'),
            trackTitle: document.getElementById('trackTitle'),
            trackArtist: document.getElementById('trackArtist'),
            trackAlbum: document.getElementById('trackAlbum'),
            playBtn: document.getElementById('playBtn'),
            prevBtn: document.getElementById('prevBtn'),
            nextBtn: document.getElementById('nextBtn'),
            shuffleBtn: document.getElementById('shuffleBtn'),
            repeatBtn: document.getElementById('repeatBtn'),
            progressBar: document.getElementById('progressBar'),
            progressFill: document.getElementById('progressFill'),
            currentTime: document.getElementById('currentTime'),
            totalTime: document.getElementById('totalTime'),
            volumeSlider: document.getElementById('volumeSlider'),
            volumeFill: document.getElementById('volumeFill'),
            volumeBtn: document.getElementById('volumeBtn'),
            likeBtn: document.getElementById('likeBtn'),
            nowPlaying: document.getElementById('nowPlaying'),
            clearQueue: document.getElementById('clearQueue'),
            uploadBtn: document.getElementById('uploadBtn'),
            fileInput: document.getElementById('fileInput'),
            audioPlayer: document.getElementById('audioPlayer'),
            videoPlayer: document.getElementById('videoPlayer'),
            cloudBtn: document.getElementById('cloudBtn'),
            sidebar: document.getElementById('sidebar'),
            sidebarCollapseBtn: document.getElementById('sidebarCollapseBtn'),
            sidebarExpandBtn: document.getElementById('sidebarExpandBtn'),
            sidebarToggle: document.getElementById('sidebarToggle'),
            // Auth elements
            authModal: document.getElementById('authModal'),
            closeAuthModal: document.getElementById('closeAuthModal'),
            showAuthBtn: document.getElementById('showAuthBtn'),
            loginForm: document.getElementById('loginForm'),
            registerForm: document.getElementById('registerForm'),
            loginEmail: document.getElementById('loginEmail'),
            loginPassword: document.getElementById('loginPassword'),
            registerName: document.getElementById('registerName'),
            registerEmail: document.getElementById('registerEmail'),
            registerPassword: document.getElementById('registerPassword'),
            googleLoginBtn: document.getElementById('googleLoginBtn'),
            googleRegisterBtn: document.getElementById('googleRegisterBtn'),
            authError: document.getElementById('authError'),
            loggedOutView: document.getElementById('loggedOutView'),
            loggedInView: document.getElementById('loggedInView'),
            userAvatar: document.getElementById('userAvatar'),
            userName: document.getElementById('userName'),
            userEmail: document.getElementById('userEmail'),
            logoutBtn: document.getElementById('logoutBtn'),
            // Settings elements
            settingsBtn: document.getElementById('settingsBtn'),
            settingsModal: document.getElementById('settingsModal'),
            closeSettings: document.getElementById('closeSettings'),
            advancedMode: document.getElementById('advancedMode'),
            pwaInstallBtn: document.getElementById('pwaInstallBtn'),
            pwaSection: document.getElementById('pwaSection'),
            versionNumber: document.getElementById('versionNumber'),
            checkUpdatesBtn: document.getElementById('checkUpdatesBtn'),
            viewChangelogBtn: document.getElementById('viewChangelogBtn'),
            // Changelog
            changelogModal: document.getElementById('changelogModal'),
            closeChangelog: document.getElementById('closeChangelog'),
            // Playlists
            playlistModal: document.getElementById('playlistModal'),
            closePlaylist: document.getElementById('closePlaylist'),
            playlistForm: document.getElementById('playlistForm'),
            playlistName: document.getElementById('playlistName'),
            playlistDescription: document.getElementById('playlistDescription'),
            playlistModalTitle: document.getElementById('playlistModalTitle'),
            editPlaylistId: document.getElementById('editPlaylistId'),
            createPlaylistBtn: document.getElementById('createPlaylistBtn'),
            playlistsContainer: document.getElementById('playlists'),
            favoritesContainer: document.getElementById('favorites'),
            // Metadata editor
            metadataModal: document.getElementById('metadataModal'),
            closeMetadata: document.getElementById('closeMetadata'),
            metadataForm: document.getElementById('metadataForm'),
            metaTitle: document.getElementById('metaTitle'),
            metaArtist: document.getElementById('metaArtist'),
            metaAlbum: document.getElementById('metaAlbum'),
            metaGenre: document.getElementById('metaGenre'),
            metaYear: document.getElementById('metaYear'),
            metaAlbumArt: document.getElementById('metaAlbumArt'),
            selectAlbumArtBtn: document.getElementById('selectAlbumArtBtn'),
            clearAlbumArtBtn: document.getElementById('clearAlbumArtBtn'),
            albumArtFileName: document.getElementById('albumArtFileName'),
            downloadWithMetadataBtn: document.getElementById('downloadWithMetadataBtn'),
            editSongId: document.getElementById('editSongId'),
            editMetadataBtn: document.getElementById('editMetadataBtn'),
            // Views
            queueView: document.getElementById('queueView'),
            playlistsView: document.getElementById('playlistsView'),
            favoritesView: document.getElementById('favoritesView'),
            toastContainer: document.getElementById('toastContainer'),
            // PiP elements
            pipPlayer: document.getElementById('pipPlayer'),
            pipClose: document.getElementById('pipClose'),
            pipAlbumArt: document.getElementById('pipAlbumArt'),
            pipVideo: document.getElementById('pipVideo'),
            pipTitle: document.getElementById('pipTitle'),
            pipArtist: document.getElementById('pipArtist'),
            pipAlbum: document.getElementById('pipAlbum'),
            pipProgressFill: document.getElementById('pipProgressFill'),
            pipPrevBtn: document.getElementById('pipPrevBtn'),
            pipPlayBtn: document.getElementById('pipPlayBtn'),
            pipNextBtn: document.getElementById('pipNextBtn'),
            pipToggleBtn: document.getElementById('pipToggleBtn')
        };

        let nextSongId = songs.length + 1;
        let deferredPrompt = null;
        let pendingAlbumArtFile = null; // Store selected album art file for metadata editing
        let lastPipUpdate = 0; // Throttle browser PiP updates
        const PIP_UPDATE_INTERVAL = 250; // Update PiP at most every 250ms

        // Toast notification
        function showToast(message, type = 'info') {
            const toast = document.createElement('div');
            toast.className = `toast glass-card px-4 py-3 rounded-lg flex items-center gap-3 ${
                type === 'error' ? 'border-red-500' : 
                type === 'success' ? 'border-green-500' : 'border-zinc-600'
            }`;
            
            const icon = type === 'error' ? 'fa-exclamation-circle text-red-500' :
                         type === 'success' ? 'fa-check-circle text-green-500' :
                         'fa-info-circle text-blue-500';
            
            toast.innerHTML = `
                <i class="fas ${icon}"></i>
                <span>${message}</span>
            `;
            
            elements.toastContainer.appendChild(toast);
            
            setTimeout(() => {
                toast.style.opacity = '0';
                toast.style.transform = 'translateY(20px)';
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        // Global volume state for mute toggle
        let previousVolume = 70;

        // Helper functions
        function formatTime(seconds) {
            if (!seconds || isNaN(seconds)) return '0:00';
            const mins = Math.floor(seconds / 60);
            const secs = Math.floor(seconds % 60);
            return `${mins}:${secs.toString().padStart(2, '0')}`;
        }

        function createAlbumArt(gradient, title) {
            const canvas = document.createElement('canvas');
            canvas.width = 400;
            canvas.height = 400;
            const ctx = canvas.getContext('2d');
            
            // Parse gradient
            const gradientMatch = gradient.match(/linear-gradient\((\d+)deg,\s*([#\w]+)\s*\d+%,\s*([#\w]+)\s*\d+%\)/);
            if (gradientMatch) {
                const color1 = gradientMatch[2];
                const color2 = gradientMatch[3];
                
                const grd = ctx.createLinearGradient(0, 0, 400, 400);
                grd.addColorStop(0, color1);
                grd.addColorStop(1, color2);
                ctx.fillStyle = grd;
                ctx.fillRect(0, 0, 400, 400);
                
                // Add some visual elements
                ctx.fillStyle = 'rgba(255,255,255,0.1)';
                ctx.beginPath();
                ctx.arc(300, 100, 150, 0, Math.PI * 2);
                ctx.fill();
                
                ctx.fillStyle = 'rgba(0,0,0,0.1)';
                ctx.beginPath();
                ctx.arc(100, 300, 120, 0, Math.PI * 2);
                ctx.fill();
                
                // Add music note icon
                ctx.font = 'bold 80px Arial';
                ctx.fillStyle = 'rgba(255,255,255,0.3)';
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                ctx.fillText('♪', 200, 200);
            }
            
            return canvas.toDataURL();
        }

        function generateRandomGradient() {
            const randomColors = [
                '#e63946', '#9d4edd', '#00b4d8', '#fb8500',
                '#8338ec', '#06d6a0', '#495057', '#ff006e',
                '#2a9d8f', '#e76f51', '#f4a261', '#264653'
            ];
            const color1 = randomColors[Math.floor(Math.random() * randomColors.length)];
            const color2 = randomColors[Math.floor(Math.random() * randomColors.length)];
            return {
                color: color1,
                gradient: `linear-gradient(135deg, ${color1} 0%, ${color2} 100%)`
            };
        }

        // Apply theme
        function applyTheme(theme) {
            document.body.classList.remove('theme-light', 'theme-purple', 'theme-ocean');
            if (theme !== 'default') {
                document.body.classList.add(`theme-${theme}`);
            }
            state.theme = theme;
            saveState();
            
            // Update theme option buttons
            document.querySelectorAll('.theme-option').forEach(btn => {
                btn.classList.remove('border-green-500');
                if (btn.dataset.theme === theme) {
                    btn.classList.add('border-green-500');
                }
            });
        }

        // Render queue
        function renderQueue() {
            if (state.queue.length === 0) {
                elements.queue.innerHTML = `
                    <div class="text-center py-8 text-zinc-500">
                        <i class="fas fa-music text-4xl mb-3"></i>
                        <p>No songs in queue</p>
                        <p class="text-sm mt-2">Upload music to get started</p>
                    </div>
                `;
                return;
            }

            elements.queue.innerHTML = state.queue.map((song, index) => `
                <div class="queue-item flex items-center gap-3 p-3 rounded-lg cursor-pointer ${index === state.currentIndex ? 'active' : ''}" 
                     data-index="${index}">
                    <div class="w-10 h-10 rounded flex-shrink-0 flex items-center justify-center text-white text-sm font-medium"
                         style="background: ${song.gradient}">
                        ${index === state.currentIndex && state.isPlaying ? 
                            '<i class="fas fa-volume-up text-xs pulse-animation"></i>' : 
                            `<span>${index + 1}</span>`}
                    </div>
                    <div class="flex-1 min-w-0">
                        <p class="font-medium truncate ${index === state.currentIndex ? 'text-green-500' : 'text-white'}">${song.title}</p>
                        <p class="text-sm text-zinc-400 truncate">${song.artist}</p>
                    </div>
                    <span class="text-xs text-zinc-500">${formatTime(song.duration)}</span>
                    ${song.isVideo ? '<i class="fas fa-video text-xs text-zinc-500 ml-1"></i>' : ''}
                </div>
            `).join('');
            
            // Add click handlers
            document.querySelectorAll('.queue-item').forEach(item => {
                item.addEventListener('click', () => {
                    const index = parseInt(item.dataset.index);
                    if (index !== state.currentIndex) {
                        state.currentIndex = index;
                        state.currentTime = 0;
                        updateNowPlaying();
                        if (!state.isPlaying) {
                            togglePlay();
                        }
                    }
                });
            });
        }

        // Render playlists
        function renderPlaylists() {
            if (state.playlists.length === 0) {
                elements.playlistsContainer.innerHTML = `
                    <div class="text-center py-8 text-zinc-500">
                        <i class="fas fa-folder-open text-4xl mb-3"></i>
                        <p>No playlists yet</p>
                        <p class="text-sm mt-2">Create your first playlist</p>
                    </div>
                `;
                return;
            }

            elements.playlistsContainer.innerHTML = state.playlists.map(playlist => `
                <div class="playlist-item p-3 rounded-lg flex items-center gap-3 cursor-pointer" data-id="${playlist.id}">
                    <div class="w-10 h-10 rounded bg-gradient-to-br from-green-500 to-green-700 flex items-center justify-center">
                        <i class="fas fa-music text-white"></i>
                    </div>
                    <div class="flex-1 min-w-0">
                        <p class="font-medium truncate">${playlist.name}</p>
                        <p class="text-sm text-zinc-400">${playlist.songs?.length || 0} songs</p>
                    </div>
                    <div class="flex gap-2">
                        <button class="edit-playlist text-zinc-400 hover:text-white" data-id="${playlist.id}">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="delete-playlist text-zinc-400 hover:text-red-500" data-id="${playlist.id}">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
            `).join('');

            // Add event listeners
            document.querySelectorAll('.playlist-item').forEach(item => {
                item.addEventListener('click', (e) => {
                    if (!e.target.closest('.edit-playlist') && !e.target.closest('.delete-playlist')) {
                        const playlistId = item.dataset.id;
                        loadPlaylist(playlistId);
                    }
                });
            });

            document.querySelectorAll('.edit-playlist').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const playlistId = btn.dataset.id;
                    editPlaylist(playlistId);
                });
            });

            document.querySelectorAll('.delete-playlist').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const playlistId = btn.dataset.id;
                    deletePlaylist(playlistId);
                });
            });
        }

        // Render favorites
        function renderFavorites() {
            const favoriteSongs = state.queue.filter(song => state.liked.has(song.id));
            
            if (favoriteSongs.length === 0) {
                elements.favoritesContainer.innerHTML = `
                    <div class="text-center py-8 text-zinc-500">
                        <i class="fas fa-heart text-4xl mb-3"></i>
                        <p>No favorites yet</p>
                        <p class="text-sm mt-2">Like songs to add them here</p>
                    </div>
                `;
                return;
            }

            elements.favoritesContainer.innerHTML = favoriteSongs.map((song) => `
                <div class="queue-item flex items-center gap-3 p-3 rounded-lg cursor-pointer" data-song-id="${song.id}">
                    <div class="w-10 h-10 rounded flex-shrink-0 flex items-center justify-center text-white text-sm font-medium"
                         style="background: ${song.gradient}">
                        <i class="fas fa-heart text-xs"></i>
                    </div>
                    <div class="flex-1 min-w-0">
                        <p class="font-medium truncate text-white">${song.title}</p>
                        <p class="text-sm text-zinc-400 truncate">${song.artist}</p>
                    </div>
                    <span class="text-xs text-zinc-500">${formatTime(song.duration)}</span>
                </div>
            `).join('');

            // Add click handlers
            elements.favoritesContainer.querySelectorAll('.queue-item').forEach(item => {
                item.addEventListener('click', () => {
                    const songId = parseInt(item.dataset.songId);
                    const index = state.queue.findIndex(s => s.id === songId);
                    if (index !== -1) {
                        state.currentIndex = index;
                        state.currentTime = 0;
                        updateNowPlaying();
                        if (!state.isPlaying) {
                            togglePlay();
                        }
                    }
                });
            });
        }

        // Playlist functions
        function createPlaylist() {
            elements.playlistModalTitle.textContent = 'Create Playlist';
            elements.playlistName.value = '';
            elements.playlistDescription.value = '';
            elements.editPlaylistId.value = '';
            elements.playlistModal.classList.remove('hidden');
        }

        function editPlaylist(id) {
            const playlist = state.playlists.find(p => p.id === id);
            if (!playlist) return;

            elements.playlistModalTitle.textContent = 'Edit Playlist';
            elements.playlistName.value = playlist.name;
            elements.playlistDescription.value = playlist.description || '';
            elements.editPlaylistId.value = id;
            elements.playlistModal.classList.remove('hidden');
        }

        function deletePlaylist(id) {
            if (confirm('Delete this playlist?')) {
                state.playlists = state.playlists.filter(p => p.id !== id);
                saveState();
                renderPlaylists();
                showToast('Playlist deleted', 'success');
            }
        }

        function loadPlaylist(id) {
            const playlist = state.playlists.find(p => p.id === id);
            if (!playlist || !playlist.songs?.length) {
                showToast('Playlist is empty', 'info');
                return;
            }

            state.queue = [...playlist.songs];
            state.currentIndex = 0;
            state.currentTime = 0;
            updateNowPlaying();
            showView('queue');
            showToast(`Loaded "${playlist.name}"`, 'success');
        }

        // View switching
        function showView(viewName) {
            // Hide all views
            document.querySelectorAll('.view-panel').forEach(v => v.classList.add('hidden'));
            
            // Show selected view
            const viewElement = document.getElementById(`${viewName}View`);
            if (viewElement) {
                viewElement.classList.remove('hidden');
            }

            // Update nav items
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
                if (item.dataset.view === viewName) {
                    item.classList.add('active');
                }
            });

            // Render view content
            if (viewName === 'playlists') {
                renderPlaylists();
            } else if (viewName === 'favorites') {
                renderFavorites();
            }
        }

        function updateNowPlaying() {
            const song = state.queue[state.currentIndex];
            if (!song) {
                elements.trackTitle.textContent = 'Select a Track';
                elements.trackArtist.textContent = 'Upload or browse to get started';
                elements.trackAlbum.textContent = '';
                elements.albumArt.src = '';
                elements.totalTime.textContent = '0:00';
                return;
            }
            
            // Update album art with animation
            elements.nowPlaying.classList.remove('fade-in');
            void elements.nowPlaying.offsetWidth; // Trigger reflow
            elements.nowPlaying.classList.add('fade-in');
            
            // Determine if video or audio
            state.isVideo = song.isVideo || false;
            
            if (state.isVideo) {
                elements.albumArt.classList.add('hidden');
                elements.videoPlayer.classList.remove('hidden');
                elements.videoPlayer.src = song.audioUrl;
            } else {
                elements.albumArt.classList.remove('hidden');
                elements.videoPlayer.classList.add('hidden');
                
                // Handle album art - use uploaded image or generated gradient
                if (song.albumArtUrl) {
                    elements.albumArt.src = song.albumArtUrl;
                } else {
                    elements.albumArt.src = createAlbumArt(song.gradient, song.title);
                }
            }
            
            elements.albumArtContainer.style.boxShadow = `0 25px 50px -12px ${song.color}40`;
            
            elements.trackTitle.textContent = song.title;
            elements.trackArtist.textContent = song.artist;
            elements.trackAlbum.textContent = song.album || '';
            elements.totalTime.textContent = formatTime(song.duration);
            
            // Load audio/video source if it exists
            if (song.audioUrl) {
                if (state.isVideo) {
                    elements.videoPlayer.volume = state.volume / 100;
                    if (state.isPlaying) {
                        elements.videoPlayer.play().catch(e => console.log('Play failed:', e));
                    }
                } else {
                    elements.audioPlayer.src = song.audioUrl;
                    elements.audioPlayer.volume = state.volume / 100;
                    if (state.isPlaying) {
                        elements.audioPlayer.play().catch(e => console.log('Play failed:', e));
                    }
                }
            } else {
                elements.audioPlayer.src = '';
            }
            
            // Update like button
            const heartIcon = elements.likeBtn.querySelector('i');
            if (state.liked.has(song.id)) {
                heartIcon.className = 'fas fa-heart text-2xl text-green-500';
            } else {
                heartIcon.className = 'far fa-heart text-2xl';
            }
            
            // Update document title
            document.title = `${song.title} - ${song.artist} | CloudTunes`;
            
            // Update body gradient based on song color
            document.body.style.background = `linear-gradient(to bottom, ${song.color}30 0%, var(--bg-primary) 30%, #000 100%)`;
            
            // Show/hide metadata edit button based on advanced mode
            elements.editMetadataBtn.classList.toggle('hidden', !state.advancedMode);
            
            renderQueue();
            updateProgress();
            
            // Update PiP player if visible (in-page or browser)
            if (state.isPipVisible) {
                updatePipPlayer();
            }
            if (state.pipWindow && !state.pipWindow.closed) {
                updateBrowserPip();
            }
        }

        function updateProgress() {
            const song = state.queue[state.currentIndex];
            if (!song || !song.duration) return;
            
            const progress = (state.currentTime / song.duration) * 100;
            elements.progressFill.style.width = `${Math.min(progress, 100)}%`;
            elements.progressBar.value = Math.min(progress, 100);
            elements.currentTime.textContent = formatTime(state.currentTime);
            
            // Update in-page PiP progress
            if (state.isPipVisible && !state.pipWindow) {
                elements.pipProgressFill.style.width = `${Math.min(progress, 100)}%`;
            }
            
            // Update browser PiP window (throttled to reduce DOM updates)
            if (state.pipWindow && !state.pipWindow.closed) {
                const now = Date.now();
                if (now - lastPipUpdate >= PIP_UPDATE_INTERVAL) {
                    lastPipUpdate = now;
                    updateBrowserPip();
                }
            }
        }

        // Picture-in-Picture functions
        function updatePipPlayer() {
            const song = state.queue[state.currentIndex];
            const defaultAlbumArt = "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Crect fill='%23333' width='100' height='100'/%3E%3Ctext x='50' y='55' font-family='Arial' font-size='40' fill='%23666' text-anchor='middle'%3E♪%3C/text%3E%3C/svg%3E";
            
            if (!song) {
                elements.pipTitle.textContent = 'No Track';
                elements.pipArtist.textContent = 'Select a song';
                elements.pipAlbum.textContent = '';
                elements.pipAlbumArt.src = defaultAlbumArt;
                return;
            }
            
            elements.pipTitle.textContent = song.title;
            elements.pipArtist.textContent = song.artist;
            elements.pipAlbum.textContent = song.album || '';
            
            // Update album art
            if (state.isVideo) {
                elements.pipAlbumArt.classList.add('hidden');
                elements.pipVideo.classList.remove('hidden');
                elements.pipVideo.src = song.audioUrl;
            } else {
                elements.pipAlbumArt.classList.remove('hidden');
                elements.pipVideo.classList.add('hidden');
                if (song.albumArtUrl) {
                    elements.pipAlbumArt.src = song.albumArtUrl;
                } else {
                    elements.pipAlbumArt.src = createAlbumArt(song.gradient, song.title);
                }
            }
            
            // Update play button
            const pipIcon = elements.pipPlayBtn.querySelector('i');
            if (state.isPlaying) {
                pipIcon.className = 'fas fa-pause';
            } else {
                pipIcon.className = 'fas fa-play';
            }
            
            // Update progress
            if (song.duration) {
                const progress = (state.currentTime / song.duration) * 100;
                elements.pipProgressFill.style.width = `${Math.min(progress, 100)}%`;
            }
        }

        // Browser Picture-in-Picture (Document PiP API)
        async function openBrowserPip() {
            // Check if Document Picture-in-Picture API is supported
            if ('documentPictureInPicture' in window) {
                try {
                    // Close existing PiP window if open
                    if (state.pipWindow && !state.pipWindow.closed) {
                        state.pipWindow.close();
                    }
                    
                    // Open the Document PiP window
                    const pipWindow = await window.documentPictureInPicture.requestWindow({
                        width: 340,
                        height: 240
                    });
                    
                    state.pipWindow = pipWindow;
                    state.isPipVisible = true;
                    elements.pipToggleBtn.classList.add('active');
                    
                    // Copy styles to PiP window
                    const pipStyles = `
                        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
                        @import url('https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css');
                        
                        * {
                            font-family: 'Inter', sans-serif;
                            margin: 0;
                            padding: 0;
                            box-sizing: border-box;
                        }
                        
                        body {
                            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
                            color: white;
                            overflow: hidden;
                            height: 100vh;
                            display: flex;
                            flex-direction: column;
                        }
                        
                        .pip-container {
                            flex: 1;
                            display: flex;
                            flex-direction: column;
                            padding: 12px;
                        }
                        
                        .pip-header {
                            display: flex;
                            align-items: center;
                            gap: 12px;
                            margin-bottom: 12px;
                        }
                        
                        .pip-album-art {
                            width: 70px;
                            height: 70px;
                            border-radius: 8px;
                            overflow: hidden;
                            flex-shrink: 0;
                            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.4);
                        }
                        
                        .pip-album-art img,
                        .pip-album-art video {
                            width: 100%;
                            height: 100%;
                            object-fit: cover;
                        }
                        
                        .pip-info {
                            flex: 1;
                            min-width: 0;
                        }
                        
                        .pip-title {
                            font-size: 14px;
                            font-weight: 600;
                            color: white;
                            white-space: nowrap;
                            overflow: hidden;
                            text-overflow: ellipsis;
                            margin-bottom: 4px;
                        }
                        
                        .pip-artist {
                            font-size: 12px;
                            color: #b3b3b3;
                            white-space: nowrap;
                            overflow: hidden;
                            text-overflow: ellipsis;
                            margin-bottom: 2px;
                        }
                        
                        .pip-album {
                            font-size: 11px;
                            color: #888;
                            white-space: nowrap;
                            overflow: hidden;
                            text-overflow: ellipsis;
                            font-style: italic;
                        }
                        
                        .pip-progress {
                            height: 4px;
                            background: rgba(255, 255, 255, 0.1);
                            border-radius: 2px;
                            margin-bottom: 12px;
                            cursor: pointer;
                        }
                        
                        .pip-progress-fill {
                            height: 100%;
                            background: linear-gradient(90deg, #1DB954, #1ed760);
                            border-radius: 2px;
                            transition: width 0.1s linear;
                        }
                        
                        .pip-controls {
                            display: flex;
                            align-items: center;
                            justify-content: center;
                            gap: 16px;
                        }
                        
                        .pip-control-btn {
                            width: 40px;
                            height: 40px;
                            border-radius: 50%;
                            border: none;
                            background: rgba(255, 255, 255, 0.1);
                            color: white;
                            cursor: pointer;
                            display: flex;
                            align-items: center;
                            justify-content: center;
                            transition: all 0.15s ease;
                            font-size: 16px;
                        }
                        
                        .pip-control-btn:hover {
                            transform: scale(1.1);
                            background: rgba(255, 255, 255, 0.2);
                        }
                        
                        .pip-control-btn.play-pause {
                            width: 50px;
                            height: 50px;
                            background: #1DB954;
                            font-size: 18px;
                        }
                        
                        .pip-control-btn.play-pause:hover {
                            background: #1ed760;
                            transform: scale(1.08);
                        }
                        
                        .pip-time {
                            display: flex;
                            justify-content: space-between;
                            font-size: 10px;
                            color: #888;
                            margin-top: -8px;
                            margin-bottom: 8px;
                        }
                        
                        .pip-branding {
                            font-size: 10px;
                            color: #666;
                            text-align: center;
                            margin-top: auto;
                            padding-top: 8px;
                        }
                        
                        .hidden { display: none !important; }
                    `;
                    
                    const styleSheet = pipWindow.document.createElement('style');
                    styleSheet.textContent = pipStyles;
                    pipWindow.document.head.appendChild(styleSheet);
                    
                    // Create PiP content
                    const song = state.queue[state.currentIndex];
                    const defaultAlbumArt = "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Crect fill='%23333' width='100' height='100'/%3E%3Ctext x='50' y='55' font-family='Arial' font-size='40' fill='%23666' text-anchor='middle'%3E♪%3C/text%3E%3C/svg%3E";
                    
                    const pipContainer = pipWindow.document.createElement('div');
                    pipContainer.className = 'pip-container';
                    pipContainer.innerHTML = `
                        <div class="pip-header">
                            <div class="pip-album-art">
                                <img id="pipArt" src="${song?.albumArtUrl || (song ? createAlbumArt(song.gradient, song.title) : defaultAlbumArt)}" alt="Album Art">
                                <video id="pipVid" class="hidden" muted></video>
                            </div>
                            <div class="pip-info">
                                <div id="pipTitle" class="pip-title">${song?.title || 'No Track'}</div>
                                <div id="pipArtist" class="pip-artist">${song?.artist || 'Select a song'}</div>
                                <div id="pipAlbum" class="pip-album">${song?.album || ''}</div>
                            </div>
                        </div>
                        <div class="pip-time">
                            <span id="pipCurrentTime">${formatTime(state.currentTime)}</span>
                            <span id="pipTotalTime">${formatTime(song?.duration || 0)}</span>
                        </div>
                        <div class="pip-progress" id="pipProgressBar">
                            <div id="pipProgressFill" class="pip-progress-fill" style="width: ${song?.duration ? (state.currentTime / song.duration) * 100 : 0}%"></div>
                        </div>
                        <div class="pip-controls">
                            <button id="pipPrev" class="pip-control-btn" title="Previous">
                                <i class="fas fa-step-backward"></i>
                            </button>
                            <button id="pipPlay" class="pip-control-btn play-pause" title="${state.isPlaying ? 'Pause' : 'Play'}">
                                <i class="fas fa-${state.isPlaying ? 'pause' : 'play'}"></i>
                            </button>
                            <button id="pipNext" class="pip-control-btn" title="Next">
                                <i class="fas fa-step-forward"></i>
                            </button>
                        </div>
                        <div class="pip-branding">CloudTunes ♪</div>
                    `;
                    
                    pipWindow.document.body.appendChild(pipContainer);
                    
                    // Add event listeners in PiP window
                    const pipPlayBtn = pipWindow.document.getElementById('pipPlay');
                    const pipPrevBtn = pipWindow.document.getElementById('pipPrev');
                    const pipNextBtn = pipWindow.document.getElementById('pipNext');
                    const pipProgressBar = pipWindow.document.getElementById('pipProgressBar');
                    
                    pipPlayBtn.addEventListener('click', () => {
                        togglePlay();
                        pipPlayBtn.querySelector('i').className = `fas fa-${state.isPlaying ? 'pause' : 'play'}`;
                    });
                    
                    pipPrevBtn.addEventListener('click', () => {
                        playPrev();
                        if (!state.isPlaying && state.queue.length > 0) togglePlay();
                        pipPlayBtn.querySelector('i').className = `fas fa-${state.isPlaying ? 'pause' : 'play'}`;
                    });
                    
                    pipNextBtn.addEventListener('click', () => {
                        playNext();
                        if (!state.isPlaying && state.queue.length > 0) togglePlay();
                        pipPlayBtn.querySelector('i').className = `fas fa-${state.isPlaying ? 'pause' : 'play'}`;
                    });
                    
                    // Click on progress bar to seek
                    pipProgressBar.addEventListener('click', (e) => {
                        const song = state.queue[state.currentIndex];
                        if (!song || !song.duration) return;
                        const rect = pipProgressBar.getBoundingClientRect();
                        const percent = (e.clientX - rect.left) / rect.width;
                        const newTime = percent * song.duration;
                        const player = state.isVideo ? elements.videoPlayer : elements.audioPlayer;
                        player.currentTime = newTime;
                        state.currentTime = newTime;
                        updateProgress();
                    });
                    
                    // Handle PiP window close
                    pipWindow.addEventListener('pagehide', () => {
                        state.pipWindow = null;
                        state.isPipVisible = false;
                        elements.pipToggleBtn.classList.remove('active');
                    });
                    
                    showToast('Picture-in-Picture opened - persists across tabs!', 'success');
                    return true;
                } catch (error) {
                    console.error('Document PiP error:', error);
                    // Fall through to try video PiP
                }
            }
            
            // Fallback: Try native video Picture-in-Picture for video content
            if (state.isVideo && elements.videoPlayer.src && document.pictureInPictureEnabled) {
                try {
                    await elements.videoPlayer.requestPictureInPicture();
                    state.isPipVisible = true;
                    elements.pipToggleBtn.classList.add('active');
                    showToast('Video Picture-in-Picture enabled', 'success');
                    return true;
                } catch (error) {
                    console.error('Video PiP error:', error);
                }
            }
            
            // Last fallback: use in-page mini player
            return false;
        }
        
        async function togglePipPlayer() {
            // If already in browser PiP, close it
            if (state.pipWindow && !state.pipWindow.closed) {
                state.pipWindow.close();
                state.pipWindow = null;
                state.isPipVisible = false;
                elements.pipToggleBtn.classList.remove('active');
                showToast('Picture-in-Picture closed');
                return;
            }
            
            // If video is in PiP mode, exit it
            if (document.pictureInPictureElement) {
                await document.exitPictureInPicture();
                state.isPipVisible = false;
                elements.pipToggleBtn.classList.remove('active');
                showToast('Picture-in-Picture closed');
                return;
            }
            
            // Try to open browser PiP
            const browserPipOpened = await openBrowserPip();
            
            if (!browserPipOpened) {
                // Fallback to in-page PiP player
                state.isPipVisible = !state.isPipVisible;
                
                if (state.isPipVisible) {
                    elements.pipPlayer.classList.remove('hidden', 'pip-slide-out');
                    elements.pipPlayer.classList.add('pip-slide-in');
                    elements.pipToggleBtn.classList.add('active');
                    updatePipPlayer();
                    showToast('Mini player enabled (browser PiP not supported)');
                } else {
                    elements.pipPlayer.classList.remove('pip-slide-in');
                    elements.pipPlayer.classList.add('pip-slide-out');
                    elements.pipToggleBtn.classList.remove('active');
                    setTimeout(() => {
                        if (!state.isPipVisible) {
                            elements.pipPlayer.classList.add('hidden');
                        }
                    }, 300);
                }
            } else {
                // Hide in-page PiP when browser PiP is active
                elements.pipPlayer.classList.add('hidden');
            }
        }

        function closePipPlayer() {
            // Close browser PiP if open
            if (state.pipWindow && !state.pipWindow.closed) {
                state.pipWindow.close();
                state.pipWindow = null;
            }
            
            // Exit video PiP if active
            if (document.pictureInPictureElement) {
                document.exitPictureInPicture().catch(e => {
                    // Expected if PiP is already closed or not supported
                    console.debug('Could not exit PiP:', e.message);
                });
            }
            
            state.isPipVisible = false;
            elements.pipPlayer.classList.remove('pip-slide-in');
            elements.pipPlayer.classList.add('pip-slide-out');
            elements.pipToggleBtn.classList.remove('active');
            setTimeout(() => {
                elements.pipPlayer.classList.add('hidden');
            }, 300);
        }
        
        // Update browser PiP window content
        function updateBrowserPip() {
            if (!state.pipWindow || state.pipWindow.closed) return;
            
            const song = state.queue[state.currentIndex];
            const defaultAlbumArt = "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Crect fill='%23333' width='100' height='100'/%3E%3Ctext x='50' y='55' font-family='Arial' font-size='40' fill='%23666' text-anchor='middle'%3E♪%3C/text%3E%3C/svg%3E";
            
            try {
                const pipDoc = state.pipWindow.document;
                const pipTitle = pipDoc.getElementById('pipTitle');
                const pipArtist = pipDoc.getElementById('pipArtist');
                const pipAlbum = pipDoc.getElementById('pipAlbum');
                const pipArt = pipDoc.getElementById('pipArt');
                const pipProgressFill = pipDoc.getElementById('pipProgressFill');
                const pipPlayBtn = pipDoc.getElementById('pipPlay');
                const pipCurrentTime = pipDoc.getElementById('pipCurrentTime');
                const pipTotalTime = pipDoc.getElementById('pipTotalTime');
                
                if (song) {
                    if (pipTitle) pipTitle.textContent = song.title;
                    if (pipArtist) pipArtist.textContent = song.artist;
                    if (pipAlbum) pipAlbum.textContent = song.album || '';
                    if (pipArt) pipArt.src = song.albumArtUrl || createAlbumArt(song.gradient, song.title);
                    if (pipCurrentTime) pipCurrentTime.textContent = formatTime(state.currentTime);
                    if (pipTotalTime) pipTotalTime.textContent = formatTime(song.duration || 0);
                    if (pipProgressFill && song.duration) {
                        pipProgressFill.style.width = `${(state.currentTime / song.duration) * 100}%`;
                    }
                } else {
                    if (pipTitle) pipTitle.textContent = 'No Track';
                    if (pipArtist) pipArtist.textContent = 'Select a song';
                    if (pipAlbum) pipAlbum.textContent = '';
                    if (pipArt) pipArt.src = defaultAlbumArt;
                }
                
                if (pipPlayBtn) {
                    pipPlayBtn.querySelector('i').className = `fas fa-${state.isPlaying ? 'pause' : 'play'}`;
                }
            } catch (e) {
                // PiP window might be closed - this is expected behavior
                console.debug('Could not update PiP:', e.message);
            }
        }

        // Make PiP player draggable (for fallback in-page PiP)
        function initPipDrag() {
            let isDragging = false;
            let startX, startY, startLeft, startTop;
            
            elements.pipPlayer.addEventListener('mousedown', (e) => {
                if (e.target.closest('button')) return;
                isDragging = true;
                startX = e.clientX;
                startY = e.clientY;
                const rect = elements.pipPlayer.getBoundingClientRect();
                startLeft = rect.left;
                startTop = rect.top;
                elements.pipPlayer.style.cursor = 'grabbing';
            });
            
            document.addEventListener('mousemove', (e) => {
                if (!isDragging) return;
                const deltaX = e.clientX - startX;
                const deltaY = e.clientY - startY;
                
                let newLeft = startLeft + deltaX;
                let newTop = startTop + deltaY;
                
                // Keep within viewport bounds
                const pipWidth = elements.pipPlayer.offsetWidth;
                const pipHeight = elements.pipPlayer.offsetHeight;
                newLeft = Math.max(0, Math.min(window.innerWidth - pipWidth, newLeft));
                newTop = Math.max(0, Math.min(window.innerHeight - pipHeight, newTop));
                
                elements.pipPlayer.style.right = 'auto';
                elements.pipPlayer.style.bottom = 'auto';
                elements.pipPlayer.style.left = `${newLeft}px`;
                elements.pipPlayer.style.top = `${newTop}px`;
            });
            
            document.addEventListener('mouseup', () => {
                if (isDragging) {
                    isDragging = false;
                    elements.pipPlayer.style.cursor = 'grab';
                }
            });
            
            // Touch support for mobile
            elements.pipPlayer.addEventListener('touchstart', (e) => {
                if (e.target.closest('button')) return;
                isDragging = true;
                const touch = e.touches[0];
                startX = touch.clientX;
                startY = touch.clientY;
                const rect = elements.pipPlayer.getBoundingClientRect();
                startLeft = rect.left;
                startTop = rect.top;
            });
            
            document.addEventListener('touchmove', (e) => {
                if (!isDragging) return;
                const touch = e.touches[0];
                const deltaX = touch.clientX - startX;
                const deltaY = touch.clientY - startY;
                
                let newLeft = startLeft + deltaX;
                let newTop = startTop + deltaY;
                
                const pipWidth = elements.pipPlayer.offsetWidth;
                const pipHeight = elements.pipPlayer.offsetHeight;
                newLeft = Math.max(0, Math.min(window.innerWidth - pipWidth, newLeft));
                newTop = Math.max(0, Math.min(window.innerHeight - pipHeight, newTop));
                
                elements.pipPlayer.style.right = 'auto';
                elements.pipPlayer.style.bottom = 'auto';
                elements.pipPlayer.style.left = `${newLeft}px`;
                elements.pipPlayer.style.top = `${newTop}px`;
            });
            
            document.addEventListener('touchend', () => {
                isDragging = false;
            });
        }
        
        // Listen for video PiP events
        elements.videoPlayer.addEventListener('enterpictureinpicture', () => {
            state.isPipVisible = true;
            elements.pipToggleBtn.classList.add('active');
        });
        
        elements.videoPlayer.addEventListener('leavepictureinpicture', () => {
            state.isPipVisible = false;
            elements.pipToggleBtn.classList.remove('active');
        });

        function togglePlay() {
            state.isPlaying = !state.isPlaying;
            const icon = elements.playBtn.querySelector('i');
            const pipIcon = elements.pipPlayBtn.querySelector('i');
            
            if (state.isPlaying) {
                icon.className = 'fas fa-pause text-xl';
                elements.playBtn.title = 'Pause';
                pipIcon.className = 'fas fa-pause';
            } else {
                icon.className = 'fas fa-play text-xl ml-1';
                elements.playBtn.title = 'Play';
                pipIcon.className = 'fas fa-play';
            }
            
            // Update browser PiP window play button
            if (state.pipWindow && !state.pipWindow.closed) {
                try {
                    const pipPlayBtn = state.pipWindow.document.getElementById('pipPlay');
                    if (pipPlayBtn) {
                        pipPlayBtn.querySelector('i').className = `fas fa-${state.isPlaying ? 'pause' : 'play'}`;
                    }
                } catch (e) {
                    // PiP window might be closed
                }
            }
            
            // Control audio/video playback
            const song = state.queue[state.currentIndex];
            if (song && song.audioUrl) {
                const player = state.isVideo ? elements.videoPlayer : elements.audioPlayer;
                if (state.isPlaying) {
                    player.play().catch(e => console.log('Play failed:', e));
                } else {
                    player.pause();
                }
            }
            
            renderQueue();
        }

        function playNext() {
            if (state.queue.length === 0) return;
            
            if (state.repeatMode === 2) {
                // Repeat one
                state.currentTime = 0;
            } else if (state.isShuffle) {
                // Shuffle mode
                let newIndex;
                do {
                    newIndex = Math.floor(Math.random() * state.queue.length);
                } while (newIndex === state.currentIndex && state.queue.length > 1);
                state.currentIndex = newIndex;
                state.currentTime = 0;
            } else {
                // Normal next
                state.currentIndex = (state.currentIndex + 1) % state.queue.length;
                state.currentTime = 0;
                
                // Stop if we've gone through all songs and repeat is off
                if (state.currentIndex === 0 && state.repeatMode === 0) {
                    state.isPlaying = false;
                    const icon = elements.playBtn.querySelector('i');
                    icon.className = 'fas fa-play text-xl ml-1';
                }
            }
            
            updateNowPlaying();
        }

        function playPrev() {
            if (state.queue.length === 0) return;
            
            if (state.currentTime > 3) {
                // If more than 3 seconds in, restart current song
                state.currentTime = 0;
                const player = state.isVideo ? elements.videoPlayer : elements.audioPlayer;
                if (player.src) {
                    player.currentTime = 0;
                }
            } else {
                // Go to previous song
                state.currentIndex = (state.currentIndex - 1 + state.queue.length) % state.queue.length;
                state.currentTime = 0;
            }
            
            updateNowPlaying();
        }

        function toggleShuffle() {
            state.isShuffle = !state.isShuffle;
            elements.shuffleBtn.classList.toggle('text-green-500', state.isShuffle);
            elements.shuffleBtn.classList.toggle('text-zinc-400', !state.isShuffle);
            showToast(state.isShuffle ? 'Shuffle on' : 'Shuffle off');
        }

        function toggleRepeat() {
            state.repeatMode = (state.repeatMode + 1) % 3;
            const icon = elements.repeatBtn.querySelector('i');
            
            elements.repeatBtn.classList.remove('text-green-500', 'text-zinc-400');
            
            const messages = ['Repeat off', 'Repeat all', 'Repeat one'];
            showToast(messages[state.repeatMode]);
            
            switch (state.repeatMode) {
                case 0:
                    icon.className = 'fas fa-redo text-lg';
                    elements.repeatBtn.classList.add('text-zinc-400');
                    elements.repeatBtn.innerHTML = '<i class="fas fa-redo text-lg"></i>';
                    break;
                case 1:
                    icon.className = 'fas fa-redo text-lg';
                    elements.repeatBtn.classList.add('text-green-500');
                    elements.repeatBtn.innerHTML = '<i class="fas fa-redo text-lg"></i>';
                    break;
                case 2:
                    elements.repeatBtn.classList.add('text-green-500');
                    elements.repeatBtn.innerHTML = '<i class="fas fa-redo text-lg"></i><span class="absolute -top-1 -right-1 text-xs">1</span>';
                    elements.repeatBtn.classList.add('relative');
                    break;
            }
            
            if (state.repeatMode !== 2) {
                elements.repeatBtn.classList.remove('relative');
            }
        }

        function updateVolume(value) {
            state.volume = value;
            elements.volumeFill.style.width = `${value}%`;
            
            const player = state.isVideo ? elements.videoPlayer : elements.audioPlayer;
            player.volume = value / 100;
            
            const icon = elements.volumeBtn.querySelector('i');
            if (value === 0) {
                icon.className = 'fas fa-volume-mute';
            } else if (value < 50) {
                icon.className = 'fas fa-volume-down';
            } else {
                icon.className = 'fas fa-volume-up';
            }
            
            saveState();
        }

        function toggleLike() {
            const song = state.queue[state.currentIndex];
            if (!song) return;
            
            const heartIcon = elements.likeBtn.querySelector('i');
            
            if (state.liked.has(song.id)) {
                state.liked.delete(song.id);
                heartIcon.className = 'far fa-heart text-2xl';
                showToast('Removed from favorites');
            } else {
                state.liked.add(song.id);
                heartIcon.className = 'fas fa-heart text-2xl text-green-500';
                
                // Add animation
                heartIcon.style.transform = 'scale(1.3)';
                setTimeout(() => {
                    heartIcon.style.transform = 'scale(1)';
                }, 200);
                showToast('Added to favorites');
            }
            
            saveState();
        }

        // Sidebar collapse
        function toggleSidebar() {
            const isCollapsed = elements.sidebar.classList.contains('sidebar-collapsed');
            
            if (isCollapsed) {
                elements.sidebar.classList.remove('sidebar-collapsed');
                elements.sidebarExpandBtn.classList.add('hidden');
                elements.sidebarCollapseBtn.querySelector('i').className = 'fas fa-chevron-left';
            } else {
                elements.sidebar.classList.add('sidebar-collapsed');
                elements.sidebarExpandBtn.classList.remove('hidden');
                elements.sidebarCollapseBtn.querySelector('i').className = 'fas fa-chevron-right';
            }
        }

        // Auth functions
        function showAuthModal() {
            elements.authModal.classList.remove('hidden');
            elements.authError.classList.add('hidden');
        }

        function hideAuthModal() {
            elements.authModal.classList.add('hidden');
        }

        function showAuthError(message) {
            elements.authError.textContent = message;
            elements.authError.classList.remove('hidden');
        }

        function updateUserUI(user) {
            if (user) {
                elements.loggedOutView.classList.add('hidden');
                elements.loggedInView.classList.remove('hidden');
                elements.userName.textContent = user.displayName || 'User';
                elements.userEmail.textContent = user.email;
                elements.userAvatar.textContent = (user.displayName || user.email || 'U').charAt(0).toUpperCase();
                
                if (user.photoURL) {
                    elements.userAvatar.innerHTML = `<img src="${user.photoURL}" alt="Avatar" class="w-full h-full rounded-full">`;
                }
                
                state.currentUser = user;
            } else {
                elements.loggedOutView.classList.remove('hidden');
                elements.loggedInView.classList.add('hidden');
                state.currentUser = null;
            }
        }

        // Event listeners
        elements.playBtn.addEventListener('click', togglePlay);
        elements.nextBtn.addEventListener('click', () => {
            playNext();
            if (!state.isPlaying && state.queue.length > 0) togglePlay();
        });
        elements.prevBtn.addEventListener('click', () => {
            playPrev();
            if (!state.isPlaying && state.queue.length > 0) togglePlay();
        });
        elements.shuffleBtn.addEventListener('click', toggleShuffle);
        elements.repeatBtn.addEventListener('click', toggleRepeat);
        elements.likeBtn.addEventListener('click', toggleLike);

        // PiP player event listeners
        elements.pipToggleBtn.addEventListener('click', togglePipPlayer);
        elements.pipClose.addEventListener('click', closePipPlayer);
        elements.pipPlayBtn.addEventListener('click', togglePlay);
        elements.pipPrevBtn.addEventListener('click', () => {
            playPrev();
            if (!state.isPlaying && state.queue.length > 0) togglePlay();
        });
        elements.pipNextBtn.addEventListener('click', () => {
            playNext();
            if (!state.isPlaying && state.queue.length > 0) togglePlay();
        });

        elements.progressBar.addEventListener('input', (e) => {
            const song = state.queue[state.currentIndex];
            if (!song || !song.duration) return;
            state.currentTime = (e.target.value / 100) * song.duration;
            updateProgress();
        });

        elements.volumeSlider.addEventListener('input', (e) => {
            updateVolume(parseInt(e.target.value));
        });

        elements.volumeBtn.addEventListener('click', () => {
            if (state.volume > 0) {
                previousVolume = state.volume;
                updateVolume(0);
                elements.volumeSlider.value = 0;
            } else {
                updateVolume(previousVolume);
                elements.volumeSlider.value = previousVolume;
            }
        });

        elements.clearQueue.addEventListener('click', () => {
            if (state.queue.length === 0) return;
            if (confirm('Clear the queue?')) {
                // Stop playback
                elements.audioPlayer.pause();
                elements.videoPlayer.pause();
                
                state.queue = [];
                state.currentIndex = 0;
                state.currentTime = 0;
                state.isPlaying = false;
                const icon = elements.playBtn.querySelector('i');
                icon.className = 'fas fa-play text-xl ml-1';
                updateNowPlaying();
                showToast('Queue cleared');
            }
        });

        // Sidebar controls
        elements.sidebarCollapseBtn.addEventListener('click', toggleSidebar);
        elements.sidebarExpandBtn.addEventListener('click', toggleSidebar);
        elements.sidebarToggle?.addEventListener('click', toggleSidebar);

        // Navigation
        document.querySelectorAll('.nav-item[data-view]').forEach(item => {
            item.addEventListener('click', () => {
                showView(item.dataset.view);
            });
        });

        // Auth modal
        elements.showAuthBtn.addEventListener('click', showAuthModal);
        elements.closeAuthModal.addEventListener('click', hideAuthModal);

        // Auth tabs
        document.querySelectorAll('.tab-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                const tab = btn.dataset.tab;
                
                document.querySelectorAll('.tab-btn').forEach(b => {
                    b.classList.remove('active');
                    b.classList.add('text-zinc-400');
                });
                btn.classList.add('active');
                btn.classList.remove('text-zinc-400');
                
                document.querySelectorAll('.auth-tab').forEach(t => t.classList.add('hidden'));
                document.getElementById(`${tab}Tab`).classList.remove('hidden');
            });
        });

        // Login form
        elements.loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = elements.loginEmail.value;
            const password = elements.loginPassword.value;
            
            try {
                await window.firebaseAuth.signInWithEmailAndPassword(email, password);
                hideAuthModal();
                showToast('Signed in successfully', 'success');
            } catch (error) {
                showAuthError(error.message);
            }
        });

        // Register form
        elements.registerForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const name = elements.registerName.value;
            const email = elements.registerEmail.value;
            const password = elements.registerPassword.value;
            
            try {
                const result = await window.firebaseAuth.createUserWithEmailAndPassword(email, password);
                await window.firebaseAuth.updateProfile(result.user, { displayName: name });
                hideAuthModal();
                showToast('Account created successfully', 'success');
            } catch (error) {
                showAuthError(error.message);
            }
        });

        // Google auth
        elements.googleLoginBtn.addEventListener('click', async () => {
            try {
                await window.firebaseAuth.signInWithGoogle();
                hideAuthModal();
                showToast('Signed in with Google', 'success');
            } catch (error) {
                showAuthError(error.message);
            }
        });

        elements.googleRegisterBtn.addEventListener('click', async () => {
            try {
                await window.firebaseAuth.signInWithGoogle();
                hideAuthModal();
                showToast('Signed in with Google', 'success');
            } catch (error) {
                showAuthError(error.message);
            }
        });

        // Logout
        elements.logoutBtn.addEventListener('click', async () => {
            try {
                await window.firebaseAuth.signOut();
                showToast('Signed out', 'success');
            } catch (error) {
                showToast('Error signing out', 'error');
            }
        });

        // Settings
        elements.settingsBtn.addEventListener('click', () => {
            elements.settingsModal.classList.remove('hidden');
        });

        elements.closeSettings.addEventListener('click', () => {
            elements.settingsModal.classList.add('hidden');
        });

        // Theme selection
        document.querySelectorAll('.theme-option').forEach(btn => {
            btn.addEventListener('click', () => {
                applyTheme(btn.dataset.theme);
            });
        });

        // Advanced mode
        elements.advancedMode.addEventListener('change', () => {
            state.advancedMode = elements.advancedMode.checked;
            elements.editMetadataBtn.classList.toggle('hidden', !state.advancedMode);
            saveState();
            showToast(state.advancedMode ? 'Advanced mode enabled' : 'Advanced mode disabled');
        });

        // PWA Install
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            elements.pwaSection.classList.remove('hidden');
        });

        elements.pwaInstallBtn.addEventListener('click', async () => {
            if (deferredPrompt) {
                deferredPrompt.prompt();
                const result = await deferredPrompt.userChoice;
                if (result.outcome === 'accepted') {
                    showToast('App installed successfully', 'success');
                }
                deferredPrompt = null;
            } else {
                showToast('App is already installed or not supported', 'info');
            }
        });

        // Version info
        elements.versionNumber.textContent = APP_VERSION;

        elements.checkUpdatesBtn.addEventListener('click', () => {
            showToast('You are using the latest version', 'success');
        });

        // Changelog
        elements.viewChangelogBtn.addEventListener('click', () => {
            elements.settingsModal.classList.add('hidden');
            elements.changelogModal.classList.remove('hidden');
        });

        elements.closeChangelog.addEventListener('click', () => {
            elements.changelogModal.classList.add('hidden');
        });

        // Playlist modal
        elements.createPlaylistBtn.addEventListener('click', createPlaylist);

        elements.closePlaylist.addEventListener('click', () => {
            elements.playlistModal.classList.add('hidden');
        });

        elements.playlistForm.addEventListener('submit', (e) => {
            e.preventDefault();
            
            const name = elements.playlistName.value.trim();
            const description = elements.playlistDescription.value.trim();
            const editId = elements.editPlaylistId.value;
            
            if (!name) return;
            
            if (editId) {
                // Update existing playlist
                const playlist = state.playlists.find(p => p.id === editId);
                if (playlist) {
                    playlist.name = name;
                    playlist.description = description;
                }
            } else {
                // Create new playlist
                const newPlaylist = {
                    id: Date.now().toString(),
                    name,
                    description,
                    songs: [...state.queue],
                    createdAt: new Date().toISOString()
                };
                state.playlists.push(newPlaylist);
            }
            
            saveState();
            renderPlaylists();
            elements.playlistModal.classList.add('hidden');
            showToast(editId ? 'Playlist updated' : 'Playlist created', 'success');
        });

        // Metadata editor
        elements.editMetadataBtn.addEventListener('click', () => {
            const song = state.queue[state.currentIndex];
            if (!song) return;
            
            elements.metaTitle.value = song.title || '';
            elements.metaArtist.value = song.artist || '';
            elements.metaAlbum.value = song.album || '';
            elements.metaGenre.value = song.genre || '';
            elements.metaYear.value = song.year || '';
            elements.editSongId.value = song.id;
            elements.albumArtFileName.textContent = 'Choose image...';
            pendingAlbumArtFile = null;
            elements.metadataModal.classList.remove('hidden');
        });

        elements.closeMetadata.addEventListener('click', () => {
            elements.metadataModal.classList.add('hidden');
            pendingAlbumArtFile = null;
        });

        // Album art selection
        elements.selectAlbumArtBtn.addEventListener('click', () => {
            elements.metaAlbumArt.click();
        });

        elements.metaAlbumArt.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                pendingAlbumArtFile = file;
                elements.albumArtFileName.textContent = file.name;
            }
        });

        elements.clearAlbumArtBtn.addEventListener('click', () => {
            pendingAlbumArtFile = null;
            elements.metaAlbumArt.value = '';
            elements.albumArtFileName.textContent = 'Choose image...';
        });

        elements.metadataForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const songId = parseInt(elements.editSongId.value);
            const song = state.queue.find(s => s.id === songId);
            
            if (song) {
                song.title = elements.metaTitle.value || song.title;
                song.artist = elements.metaArtist.value || song.artist;
                song.album = elements.metaAlbum.value;
                song.genre = elements.metaGenre.value;
                song.year = elements.metaYear.value;
                
                // Update album art if a new one was selected
                if (pendingAlbumArtFile) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        song.albumArtUrl = e.target.result;
                        song.pendingAlbumArtData = pendingAlbumArtFile;
                        updateNowPlaying();
                    };
                    reader.readAsDataURL(pendingAlbumArtFile);
                }
                
                updateNowPlaying();
                elements.metadataModal.classList.add('hidden');
                pendingAlbumArtFile = null;
                showToast('Metadata updated', 'success');
            }
        });

        // Download with metadata
        elements.downloadWithMetadataBtn.addEventListener('click', async () => {
            const songId = parseInt(elements.editSongId.value);
            const song = state.queue.find(s => s.id === songId);
            
            if (!song || !song.audioUrl) {
                showToast('No audio file to download', 'error');
                return;
            }

            showToast('Preparing download...', 'info');

            try {
                // Get the current metadata values from the form
                const metadata = {
                    title: elements.metaTitle.value || song.title,
                    artist: elements.metaArtist.value || song.artist,
                    album: elements.metaAlbum.value || song.album || '',
                    genre: elements.metaGenre.value || song.genre || '',
                    year: elements.metaYear.value || song.year || ''
                };

                // Fetch the original audio file
                let audioBlob;
                if (song.audioUrl.startsWith('blob:')) {
                    // It's a local blob URL, fetch it
                    const response = await fetch(song.audioUrl);
                    audioBlob = await response.blob();
                } else {
                    // It's a remote URL, fetch it
                    const response = await fetch(song.audioUrl);
                    if (!response.ok) throw new Error('Failed to fetch audio file');
                    audioBlob = await response.blob();
                }

                // Determine file extension
                const isVideo = song.isVideo;
                const extension = isVideo ? 'mp4' : 'mp3';
                const mimeType = isVideo ? 'video/mp4' : 'audio/mpeg';

                // For MP3 files, we can try to embed ID3 tags
                // For simplicity, we'll create a download with the metadata in the filename
                // and provide the original file (full ID3 tag embedding would require a library like id3.js)
                
                // Create a sanitized filename with metadata
                const sanitize = (str) => str.replace(/[<>:"/\\|?*]/g, '_').trim();
                const filename = `${sanitize(metadata.artist)} - ${sanitize(metadata.title)}.${extension}`;

                // For MP3 files, attempt to write ID3v2 tags (simplified approach)
                let downloadBlob = audioBlob;
                
                if (!isVideo && audioBlob.type === 'audio/mpeg') {
                    // Try to add ID3v2 tags to MP3
                    try {
                        downloadBlob = await addID3Tags(audioBlob, metadata, pendingAlbumArtFile || song.pendingAlbumArtData);
                    } catch (tagError) {
                        console.log('Could not add ID3 tags, downloading original:', tagError);
                    }
                }

                // Create download link
                const url = URL.createObjectURL(downloadBlob);
                const a = document.createElement('a');
                a.href = url;
                a.download = filename;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);

                showToast(`Downloaded: ${filename}`, 'success');
            } catch (error) {
                console.error('Download error:', error);
                showToast('Failed to download file', 'error');
            }
        });

        // Function to add ID3v2 tags to MP3 files
        async function addID3Tags(audioBlob, metadata, albumArtFile) {
            const arrayBuffer = await audioBlob.arrayBuffer();
            const uint8Array = new Uint8Array(arrayBuffer);
            
            // Check if file already has ID3v2 tag
            const hasID3v2 = uint8Array[0] === 0x49 && uint8Array[1] === 0x44 && uint8Array[2] === 0x33;
            
            // Create ID3v2.3 header and frames
            const textEncoder = new TextEncoder();
            const frames = [];
            
            // Helper to create text frame
            function createTextFrame(id, text) {
                if (!text) return null;
                const idBytes = textEncoder.encode(id);
                const textBytes = textEncoder.encode(text);
                // Frame: ID(4) + Size(4) + Flags(2) + Encoding(1) + Text
                const frameSize = 1 + textBytes.length;
                const frame = new Uint8Array(10 + frameSize);
                frame.set(idBytes, 0);
                // Size (big endian, excluding header)
                frame[4] = (frameSize >> 24) & 0xFF;
                frame[5] = (frameSize >> 16) & 0xFF;
                frame[6] = (frameSize >> 8) & 0xFF;
                frame[7] = frameSize & 0xFF;
                // Flags
                frame[8] = 0;
                frame[9] = 0;
                // Encoding (0 = ISO-8859-1)
                frame[10] = 0;
                // Text
                frame.set(textBytes, 11);
                return frame;
            }
            
            // Add text frames
            const titleFrame = createTextFrame('TIT2', metadata.title);
            const artistFrame = createTextFrame('TPE1', metadata.artist);
            const albumFrame = createTextFrame('TALB', metadata.album);
            const genreFrame = createTextFrame('TCON', metadata.genre);
            const yearFrame = createTextFrame('TYER', metadata.year);
            
            if (titleFrame) frames.push(titleFrame);
            if (artistFrame) frames.push(artistFrame);
            if (albumFrame) frames.push(albumFrame);
            if (genreFrame) frames.push(genreFrame);
            if (yearFrame) frames.push(yearFrame);
            
            // Add album art if provided
            if (albumArtFile) {
                try {
                    const artBuffer = await albumArtFile.arrayBuffer();
                    const artBytes = new Uint8Array(artBuffer);
                    const mimeType = albumArtFile.type || 'image/jpeg';
                    const mimeBytes = textEncoder.encode(mimeType);
                    
                    // APIC frame structure:
                    // Encoding(1) + MIME type + null(1) + Picture type(1) + Description + null(1) + Picture data
                    const apicSize = 1 + mimeBytes.length + 1 + 1 + 1 + artBytes.length;
                    const apicFrame = new Uint8Array(10 + apicSize);
                    
                    // Frame ID
                    apicFrame.set(textEncoder.encode('APIC'), 0);
                    // Size
                    apicFrame[4] = (apicSize >> 24) & 0xFF;
                    apicFrame[5] = (apicSize >> 16) & 0xFF;
                    apicFrame[6] = (apicSize >> 8) & 0xFF;
                    apicFrame[7] = apicSize & 0xFF;
                    // Flags
                    apicFrame[8] = 0;
                    apicFrame[9] = 0;
                    // Encoding
                    apicFrame[10] = 0;
                    // MIME type
                    apicFrame.set(mimeBytes, 11);
                    // Null terminator
                    apicFrame[11 + mimeBytes.length] = 0;
                    // Picture type (3 = front cover)
                    apicFrame[12 + mimeBytes.length] = 3;
                    // Description (empty) + null
                    apicFrame[13 + mimeBytes.length] = 0;
                    // Picture data
                    apicFrame.set(artBytes, 14 + mimeBytes.length);
                    
                    frames.push(apicFrame);
                } catch (artError) {
                    console.log('Could not add album art:', artError);
                }
            }
            
            // Calculate total size of all frames
            let framesSize = 0;
            frames.forEach(f => framesSize += f.length);
            
            // Create ID3v2.3 header
            const header = new Uint8Array(10);
            header[0] = 0x49; // 'I'
            header[1] = 0x44; // 'D'
            header[2] = 0x33; // '3'
            header[3] = 0x03; // Version 2.3
            header[4] = 0x00; // Revision
            header[5] = 0x00; // Flags
            // Size (syncsafe integer)
            const size = framesSize;
            header[6] = (size >> 21) & 0x7F;
            header[7] = (size >> 14) & 0x7F;
            header[8] = (size >> 7) & 0x7F;
            header[9] = size & 0x7F;
            
            // Combine header, frames, and original audio (skip existing ID3v2 if present)
            let audioStart = 0;
            if (hasID3v2) {
                // Parse existing ID3v2 size
                const existingSize = ((uint8Array[6] & 0x7F) << 21) |
                                    ((uint8Array[7] & 0x7F) << 14) |
                                    ((uint8Array[8] & 0x7F) << 7) |
                                    (uint8Array[9] & 0x7F);
                audioStart = 10 + existingSize;
            }
            
            const audioData = uint8Array.slice(audioStart);
            const totalSize = header.length + framesSize + audioData.length;
            const result = new Uint8Array(totalSize);
            
            let offset = 0;
            result.set(header, offset);
            offset += header.length;
            
            for (const frame of frames) {
                result.set(frame, offset);
                offset += frame.length;
            }
            
            result.set(audioData, offset);
            
            return new Blob([result], { type: 'audio/mpeg' });
        }

        // Close modals on backdrop click
        [elements.authModal, elements.settingsModal, elements.changelogModal, elements.playlistModal, elements.metadataModal].forEach(modal => {
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    modal.classList.add('hidden');
                    pendingAlbumArtFile = null;
                }
            });
        });

        // Keyboard controls
        document.addEventListener('keydown', (e) => {
            // Don't handle if typing in input
            if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') return;
            
            const song = state.queue[state.currentIndex];
            
            switch (e.code) {
                case 'Space':
                    e.preventDefault();
                    if (state.queue.length > 0) togglePlay();
                    break;
                case 'ArrowRight':
                    e.preventDefault();
                    if (e.shiftKey) {
                        playNext();
                    } else if (song && song.audioUrl) {
                        const player = state.isVideo ? elements.videoPlayer : elements.audioPlayer;
                        player.currentTime = Math.min(player.currentTime + 10, song.duration || 0);
                    }
                    break;
                case 'ArrowLeft':
                    e.preventDefault();
                    if (e.shiftKey) {
                        playPrev();
                    } else if (song && song.audioUrl) {
                        const player = state.isVideo ? elements.videoPlayer : elements.audioPlayer;
                        player.currentTime = Math.max(player.currentTime - 10, 0);
                    }
                    break;
                case 'ArrowUp':
                    e.preventDefault();
                    const newVolUp = Math.min(state.volume + 10, 100);
                    updateVolume(newVolUp);
                    elements.volumeSlider.value = newVolUp;
                    break;
                case 'ArrowDown':
                    e.preventDefault();
                    const newVolDown = Math.max(state.volume - 10, 0);
                    updateVolume(newVolDown);
                    elements.volumeSlider.value = newVolDown;
                    break;
                case 'KeyS':
                    if (!e.ctrlKey && !e.metaKey) toggleShuffle();
                    break;
                case 'KeyR':
                    toggleRepeat();
                    break;
                case 'KeyL':
                    toggleLike();
                    break;
                case 'KeyM':
                    // Mute/unmute
                    if (state.volume > 0) {
                        previousVolume = state.volume;
                        updateVolume(0);
                        elements.volumeSlider.value = 0;
                    } else {
                        updateVolume(previousVolume);
                        elements.volumeSlider.value = previousVolume;
                    }
                    break;
            }
        });

        // File upload parsing
        function parseAudioFile(file) {
            return new Promise((resolve) => {
                const isVideo = file.type.startsWith('video/') || file.name.match(/\.mp4$/i);
                
                if (isVideo) {
                    // Handle video files
                    const videoUrl = URL.createObjectURL(file);
                    const tempVideo = document.createElement('video');
                    tempVideo.src = videoUrl;
                    
                    tempVideo.addEventListener('loadedmetadata', () => {
                        const { color, gradient } = generateRandomGradient();
                        
                        // Try to extract thumbnail from video
                        tempVideo.currentTime = 1;
                        tempVideo.addEventListener('seeked', () => {
                            const canvas = document.createElement('canvas');
                            canvas.width = 400;
                            canvas.height = 400;
                            const ctx = canvas.getContext('2d');
                            ctx.drawImage(tempVideo, 0, 0, 400, 400);
                            const thumbnailUrl = canvas.toDataURL();
                            
                            resolve({
                                id: nextSongId++,
                                title: file.name.replace(/\.(mp4|mov|webm|avi)$/i, ''),
                                artist: 'Video File',
                                duration: tempVideo.duration,
                                color,
                                gradient,
                                audioUrl: videoUrl,
                                albumArtUrl: thumbnailUrl,
                                isVideo: true
                            });
                        }, { once: true });
                    });
                    
                    tempVideo.addEventListener('error', () => {
                        const { color, gradient } = generateRandomGradient();
                        resolve({
                            id: nextSongId++,
                            title: file.name.replace(/\.(mp4|mov|webm|avi)$/i, ''),
                            artist: 'Video File',
                            duration: 0,
                            color,
                            gradient,
                            audioUrl: videoUrl,
                            albumArtUrl: null,
                            isVideo: true
                        });
                    });
                    
                    return;
                }
                jsmediatags.read(file, {
                    onSuccess: (tag) => {
                        const tags = tag.tags;
                        const title = tags.title || file.name.replace(/\.(mp3|flac|wav|ogg|m4a)$/i, '');
                        const artist = tags.artist || 'Unknown Artist';
                        const album = tags.album || '';
                        const genre = tags.genre || '';
                        
                        let albumArtUrl = null;
                        if (tags.picture) {
                            const {data, type} = tags.picture;
                            const byteArray = new Uint8Array(data);
                            const blob = new Blob([byteArray], {type});
                            albumArtUrl = URL.createObjectURL(blob);
                        }
                        
                        const audioUrl = URL.createObjectURL(file);
                        const tempAudio = new Audio(audioUrl);
                        
                        tempAudio.addEventListener('loadedmetadata', () => {
                            const { color, gradient } = generateRandomGradient();
                            
                            resolve({
                                id: nextSongId++,
                                title,
                                artist,
                                album,
                                genre,
                                duration: tempAudio.duration,
                                color,
                                gradient,
                                audioUrl,
                                albumArtUrl,
                                isVideo: false
                            });
                        });

                        tempAudio.addEventListener('error', () => {
                            const { color, gradient } = generateRandomGradient();
                            resolve({
                                id: nextSongId++,
                                title,
                                artist,
                                album,
                                genre,
                                duration: 0,
                                color,
                                gradient,
                                audioUrl,
                                albumArtUrl,
                                isVideo: false
                            });
                        });
                    },
                    onError: (error) => {
                        console.log('Tag reading error:', error);
                        const audioUrl = URL.createObjectURL(file);
                        const tempAudio = new Audio(audioUrl);
                        
                        tempAudio.addEventListener('loadedmetadata', () => {
                            const { color, gradient } = generateRandomGradient();
                            
                            resolve({
                                id: nextSongId++,
                                title: file.name.replace(/\.(mp3|flac|wav|ogg|m4a)$/i, ''),
                                artist: 'Unknown Artist',
                                duration: tempAudio.duration,
                                color,
                                gradient,
                                audioUrl,
                                albumArtUrl: null,
                                isVideo: false
                            });
                        });
                        
                        tempAudio.addEventListener('error', () => {
                            const { color, gradient } = generateRandomGradient();
                            resolve({
                                id: nextSongId++,
                                title: file.name.replace(/\.(mp3|flac|wav|ogg|m4a)$/i, ''),
                                artist: 'Unknown Artist',
                                duration: 0,
                                color,
                                gradient,
                                audioUrl,
                                albumArtUrl: null,
                                isVideo: false
                            });
                        });
                    }
                });
            });
        }

        // Function to fetch metadata from remote URL
        function fetchRemoteMetadata(song) {
            return new Promise((resolve) => {
                if (song.isVideo) {
                    // For video files, just get duration
                    const tempVideo = document.createElement('video');
                    tempVideo.crossOrigin = 'anonymous';
                    tempVideo.src = song.audioUrl;
                    
                    tempVideo.addEventListener('loadedmetadata', () => {
                        song.duration = tempVideo.duration;
                        
                        // Try to extract thumbnail
                        tempVideo.currentTime = 1;
                        tempVideo.addEventListener('seeked', () => {
                            try {
                                const canvas = document.createElement('canvas');
                                canvas.width = 400;
                                canvas.height = 400;
                                const ctx = canvas.getContext('2d');
                                ctx.drawImage(tempVideo, 0, 0, 400, 400);
                                song.albumArtUrl = canvas.toDataURL();
                            } catch (e) {
                                console.log('Could not extract video thumbnail:', e);
                            }
                            resolve(song);
                        }, { once: true });
                    });
                    
                    tempVideo.addEventListener('error', () => resolve(song));
                    return;
                }
                
                // For audio files, try to read ID3 tags
                jsmediatags.read(song.audioUrl, {
                    onSuccess: (tag) => {
                        const tags = tag.tags;
                        if (tags.title) song.title = tags.title;
                        if (tags.artist) song.artist = tags.artist;
                        if (tags.album) song.album = tags.album;
                        if (tags.genre) song.genre = tags.genre;
                        if (tags.year) song.year = tags.year;
                        
                        // Extract album art
                        if (tags.picture) {
                            try {
                                const { data, format } = tags.picture;
                                const byteArray = new Uint8Array(data);
                                const blob = new Blob([byteArray], { type: format });
                                song.albumArtUrl = URL.createObjectURL(blob);
                            } catch (e) {
                                console.log('Could not extract album art:', e);
                            }
                        }
                        
                        // Get duration
                        const tempAudio = new Audio();
                        tempAudio.crossOrigin = 'anonymous';
                        tempAudio.src = song.audioUrl;
                        tempAudio.addEventListener('loadedmetadata', () => {
                            song.duration = tempAudio.duration;
                            resolve(song);
                        });
                        tempAudio.addEventListener('error', () => resolve(song));
                    },
                    onError: (error) => {
                        console.log('Remote metadata read error:', error);
                        // Still try to get duration
                        const tempAudio = new Audio();
                        tempAudio.crossOrigin = 'anonymous';
                        tempAudio.src = song.audioUrl;
                        tempAudio.addEventListener('loadedmetadata', () => {
                            song.duration = tempAudio.duration;
                            resolve(song);
                        });
                        tempAudio.addEventListener('error', () => resolve(song));
                    }
                });
            });
        }

        async function fetchGithubSongs() {
            elements.cloudBtn.disabled = true;
            elements.cloudBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Loading...';
            
            try {
                // Fetch contents from the repository
                const response = await fetch('https://api.github.com/repos/cloudcompile/music/contents/');
                if (!response.ok) throw new Error('Failed to connect to Cloud Library');
                
                const data = await response.json();
                // Filter for audio/video files
                const mediaFiles = data.filter(item => item.name.match(/\.(mp3|flac|mp4)$/i));
                
                if (mediaFiles.length === 0) {
                    showToast('No music files found in Cloud Library', 'info');
                    return;
                }
                
                let addedCount = 0;
                const songsToAdd = [];
                
                for (const file of mediaFiles) {
                    // Check if already in queue to avoid duplicates
                    const exists = state.queue.some(s => s.title === file.name.replace(/\.(mp3|flac|mp4)$/i, '').replace(/_/g, ' ') || 
                                                        s.audioUrl === file.download_url);
                    if (exists) continue;

                    const { color, gradient } = generateRandomGradient();
                    const isVideo = file.name.match(/\.mp4$/i);
                    
                    const song = {
                        id: nextSongId++,
                        title: file.name.replace(/\.(mp3|flac|mp4)$/i, '').replace(/_/g, ' '),
                        artist: 'Cloud Library',
                        album: '',
                        genre: '',
                        duration: 0,
                        color,
                        gradient,
                        audioUrl: file.download_url,
                        albumArtUrl: null,
                        isVideo: !!isVideo
                    };
                    
                    songsToAdd.push(song);
                    addedCount++;
                }
                
                if (addedCount > 0) {
                    // Add songs to queue first
                    state.queue.push(...songsToAdd);
                    renderQueue();
                    showToast(`Added ${addedCount} songs. Loading metadata...`, 'success');
                    
                    // Fetch metadata for each song in background
                    for (const song of songsToAdd) {
                        fetchRemoteMetadata(song).then((updatedSong) => {
                            // Re-render queue to show updated metadata
                            renderQueue();
                            // Update PiP if visible and this is the current song
                            if (state.isPipVisible && state.queue[state.currentIndex]?.id === updatedSong.id) {
                                updatePipPlayer();
                            }
                            // Update now playing if this is the current song
                            if (state.queue[state.currentIndex]?.id === updatedSong.id) {
                                updateNowPlaying();
                            }
                        });
                    }
                } else {
                    showToast('All songs from Cloud Library are already in queue', 'info');
                }
                
            } catch (error) {
                console.error('Cloud load error:', error);
                showToast('Could not load Cloud Library', 'error');
            } finally {
                elements.cloudBtn.disabled = false;
                elements.cloudBtn.innerHTML = '<i class="fab fa-github"></i> Load Cloud Library';
            }
        }

        elements.uploadBtn.addEventListener('click', () => {
            elements.fileInput.click();
        });
        
        elements.cloudBtn.addEventListener('click', fetchGithubSongs);

        elements.fileInput.addEventListener('change', async (e) => {
            const files = Array.from(e.target.files);
            if (files.length === 0) return;
            
            elements.uploadBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Processing...';
            elements.uploadBtn.disabled = true;

            for (const file of files) {
                // Check for audio/video type or extension
                if (file.type.startsWith('audio/') || file.type.startsWith('video/') || 
                    file.name.match(/\.(mp3|flac|wav|ogg|m4a|mp4|mov|webm|avi)$/i)) {
                    try {
                        const song = await parseAudioFile(file);
                        state.queue.push(song);
                    } catch (err) {
                        console.error("Failed to parse file", file.name, err);
                    }
                }
            }

            renderQueue();
            elements.uploadBtn.innerHTML = '<i class="fas fa-upload"></i> Upload Music';
            elements.uploadBtn.disabled = false;
            e.target.value = '';
            
            if (files.length > 0) {
                showToast(`Added ${files.length} file(s) to queue`, 'success');
            }
        });

        // Audio player event listeners
        elements.audioPlayer.addEventListener('timeupdate', () => {
            if (!elements.audioPlayer.paused && !state.isVideo) {
                state.currentTime = elements.audioPlayer.currentTime;
                updateProgress();
            }
        });

        elements.audioPlayer.addEventListener('ended', () => {
            if (!state.isVideo) playNext();
        });

        elements.audioPlayer.addEventListener('loadedmetadata', () => {
            const song = state.queue[state.currentIndex];
            if (song && song.audioUrl && !state.isVideo) {
                song.duration = elements.audioPlayer.duration;
                elements.totalTime.textContent = formatTime(song.duration);
            }
        });

        // Video player event listeners
        elements.videoPlayer.addEventListener('timeupdate', () => {
            if (!elements.videoPlayer.paused && state.isVideo) {
                state.currentTime = elements.videoPlayer.currentTime;
                updateProgress();
            }
        });

        elements.videoPlayer.addEventListener('ended', () => {
            if (state.isVideo) playNext();
        });

        elements.videoPlayer.addEventListener('loadedmetadata', () => {
            const song = state.queue[state.currentIndex];
            if (song && song.audioUrl && state.isVideo) {
                song.duration = elements.videoPlayer.duration;
                elements.totalTime.textContent = formatTime(song.duration);
            }
        });

        // Service Worker Registration
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/sw.js')
                    .then((registration) => {
                        console.log('ServiceWorker registered:', registration.scope);
                    })
                    .catch((error) => {
                        console.log('ServiceWorker registration failed:', error);
                    });
            });
        }

        // Firebase auth state listener
        window.addEventListener('load', () => {
            // Wait for Firebase to be ready
            setTimeout(() => {
                if (window.firebaseAuth) {
                    window.firebaseAuth.onAuthStateChanged((user) => {
                        updateUserUI(user);
                    });
                }
            }, 1000);
        });

        // Initialize
        loadState();
        applyTheme(state.theme);
        elements.advancedMode.checked = state.advancedMode;
        elements.volumeSlider.value = state.volume;
        updateVolume(state.volume);
        updateNowPlaying();
        initPipDrag();
    </script>
</body>
</html>